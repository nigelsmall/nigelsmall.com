<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>py2neo.neo4j &mdash; py2neo 1.6.4 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/nige.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.6.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="py2neo 1.6.4 documentation" href="../../../" />
    <link rel="up" title="py2neo" href="../" /> 
  </head>
  <body>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../">
              <img class="logo" src="../../../_static/py2neo-glossy.190x260.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
    <header>
    <div class="title"><a href="/">Nigel Small</a></div>
    <div class="contact">
    <a href="http://twitter.com/neonige"><img src="../../../_static/twitter_mark.png"></a>
    <a href="http://github.com/nigelsmall"><img src="../../../_static/github_mark.png"></a>
    </div>
    </header>
    <main>
        
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for py2neo.neo4j</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="c"># Copyright 2011-2014, Nigel Small</span>
<span class="c"># </span>
<span class="c"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c"># you may not use this file except in compliance with the License.</span>
<span class="c"># You may obtain a copy of the License at</span>
<span class="c"># </span>
<span class="c">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c"># </span>
<span class="c"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c"># See the License for the specific language governing permissions and</span>
<span class="c"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot; The neo4j module provides the main `Neo4j &lt;http://neo4j.org/&gt;`_ client</span>
<span class="sd">functionality and will be the starting point for most applications. The main</span>
<span class="sd">classes provided are:</span>

<span class="sd">- :py:class:`GraphDatabaseService` - an instance of a Neo4j database server,</span>
<span class="sd">  providing a number of graph-global methods for handling nodes and</span>
<span class="sd">  relationships</span>
<span class="sd">- :py:class:`Node` - a representation of a database node</span>
<span class="sd">- :py:class:`Relationship` - a representation of a relationship between two</span>
<span class="sd">  database nodes</span>
<span class="sd">- :py:class:`Path` - a sequence of alternating nodes and relationships</span>
<span class="sd">- :py:class:`Index` - a index of key-value pairs for storing links to nodes or</span>
<span class="sd">  relationships</span>
<span class="sd">- :py:class:`ReadBatch` - a batch of read requests to be carried out within a</span>
<span class="sd">  single transaction</span>
<span class="sd">- :py:class:`WriteBatch` - a batch of write requests to be carried out within</span>
<span class="sd">  a single transaction</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">.packages.httpstream</span> <span class="kn">import</span> <span class="p">(</span><span class="n">http</span><span class="p">,</span>
                                  <span class="n">Resource</span> <span class="k">as</span> <span class="n">_Resource</span><span class="p">,</span>
                                  <span class="n">ResourceTemplate</span> <span class="k">as</span> <span class="n">_ResourceTemplate</span><span class="p">,</span>
                                  <span class="n">ClientError</span> <span class="k">as</span> <span class="n">_ClientError</span><span class="p">,</span>
                                  <span class="n">ServerError</span> <span class="k">as</span> <span class="n">_ServerError</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.packages.jsonstream</span> <span class="kn">import</span> <span class="n">assembled</span><span class="p">,</span> <span class="n">grouped</span>
<span class="kn">from</span> <span class="nn">.packages.httpstream.numbers</span> <span class="kn">import</span> <span class="n">CREATED</span><span class="p">,</span> <span class="n">NOT_FOUND</span><span class="p">,</span> <span class="n">CONFLICT</span>
<span class="kn">from</span> <span class="nn">.packages.urimagic</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Authority</span><span class="p">,</span> <span class="n">URI</span><span class="p">,</span> <span class="n">URITemplate</span><span class="p">,</span>
                                <span class="n">Query</span><span class="p">,</span> <span class="n">percent_encode</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="o">*</span>


<span class="n">DEFAULT_SCHEME</span> <span class="o">=</span> <span class="s">&quot;http&quot;</span>
<span class="n">DEFAULT_HOST</span> <span class="o">=</span> <span class="s">&quot;localhost&quot;</span>
<span class="n">DEFAULT_PORT</span> <span class="o">=</span> <span class="mi">7474</span>
<span class="n">DEFAULT_NETLOC</span> <span class="o">=</span> <span class="s">&quot;{0}:{1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">DEFAULT_HOST</span><span class="p">,</span> <span class="n">DEFAULT_PORT</span><span class="p">)</span>
<span class="n">DEFAULT_URI</span> <span class="o">=</span> <span class="s">&quot;{0}://{1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">DEFAULT_SCHEME</span><span class="p">,</span> <span class="n">DEFAULT_NETLOC</span><span class="p">)</span>

<span class="n">PRODUCT</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;py2neo&quot;</span><span class="p">,</span> <span class="n">__version__</span><span class="p">)</span>

<span class="n">NON_ALPHA_NUM</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;[^0-9A-Za-z_]&quot;</span><span class="p">)</span>
<span class="n">SIMPLE_NAME</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;[A-Za-z_][0-9A-Za-z_]*&quot;</span><span class="p">)</span>

<span class="n">http</span><span class="o">.</span><span class="n">default_encoding</span> <span class="o">=</span> <span class="s">&quot;UTF-8&quot;</span>

<span class="n">batch_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span> <span class="o">+</span> <span class="s">&quot;.batch&quot;</span><span class="p">)</span>
<span class="n">cypher_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span> <span class="o">+</span> <span class="s">&quot;.cypher&quot;</span><span class="p">)</span>

<span class="n">_headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="bp">None</span><span class="p">:</span> <span class="p">[(</span><span class="s">&quot;X-Stream&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">)]</span>
<span class="p">}</span>

<span class="n">_http_rewrites</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">_add_header</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">host_port</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Add an HTTP header to be sent with all requests if no `host_port`</span>
<span class="sd">    is provided or only to those matching the value supplied otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">host_port</span> <span class="ow">in</span> <span class="n">_headers</span><span class="p">:</span>
        <span class="n">_headers</span><span class="p">[</span><span class="n">host_port</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_headers</span><span class="p">[</span><span class="n">host_port</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">_get_headers</span><span class="p">(</span><span class="n">host_port</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetch all HTTP headers relevant to the `host_port` provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">uri_headers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">headers</span> <span class="ow">in</span> <span class="n">_headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">==</span> <span class="n">host_port</span><span class="p">:</span>
            <span class="n">uri_headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">uri_headers</span>


<div class="viewcode-block" id="authenticate"><a class="viewcode-back" href="../../../cookbook/#py2neo.neo4j.authenticate">[docs]</a><span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="n">host_port</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Set HTTP basic authentication values for specified `host_port`. The</span>
<span class="sd">    code below shows a simple example::</span>

<span class="sd">        # set up authentication parameters</span>
<span class="sd">        neo4j.authenticate(&quot;camelot:7474&quot;, &quot;arthur&quot;, &quot;excalibur&quot;)</span>

<span class="sd">        # connect to authenticated graph database</span>
<span class="sd">        graph_db = neo4j.GraphDatabaseService(&quot;http://camelot:7474/db/data/&quot;)</span>

<span class="sd">    Note: a `netloc` can be either a server name or a server name and port</span>
<span class="sd">    number but must match exactly that used within the GraphDatabaseService</span>
<span class="sd">    URI.</span>

<span class="sd">    :param host_port: the host and optional port requiring authentication</span>
<span class="sd">        (e.g. &quot;bigserver&quot;, &quot;camelot:7474&quot;)</span>
<span class="sd">    :param user_name: the user name to authenticate as</span>
<span class="sd">    :param password: the password</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">credentials</span> <span class="o">=</span> <span class="p">(</span><span class="n">user_name</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">password</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;UTF-8&quot;</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;Basic &quot;</span> <span class="o">+</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;ASCII&quot;</span><span class="p">)</span>
    <span class="n">_add_header</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">host_port</span><span class="o">=</span><span class="n">host_port</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">familiar</span><span class="p">(</span><span class="o">*</span><span class="n">resources</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return :py:const:`True` if all resources share a common service root.</span>

<span class="sd">    :param resources:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">service_root</span> <span class="o">==</span> <span class="n">resources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">service_root</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">)</span>


<div class="viewcode-block" id="rewrite"><a class="viewcode-back" href="../../../cookbook/#py2neo.neo4j.rewrite">[docs]</a><span class="k">def</span> <span class="nf">rewrite</span><span class="p">(</span><span class="n">from_scheme_host_port</span><span class="p">,</span> <span class="n">to_scheme_host_port</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Automatically rewrite all URIs directed to the scheme, host and port</span>
<span class="sd">    specified in `from_scheme_host_port` to that specified in</span>
<span class="sd">    `to_scheme_host_port`.</span>

<span class="sd">    As an example::</span>

<span class="sd">        # implicitly convert all URIs beginning with &lt;http://localhost:7474&gt;</span>
<span class="sd">        # to instead use &lt;https://dbserver:9999&gt;</span>
<span class="sd">        neo4j.rewrite((&quot;http&quot;, &quot;localhost&quot;, 7474), (&quot;https&quot;, &quot;dbserver&quot;, 9999))</span>

<span class="sd">    If `to_scheme_host_port` is :py:const:`None` then any rewrite rule for</span>
<span class="sd">    `from_scheme_host_port` is removed.</span>

<span class="sd">    This facility is primarily intended for use by database servers behind</span>
<span class="sd">    proxies which are unaware of their externally visible network address.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_http_rewrites</span>
    <span class="k">if</span> <span class="n">to_scheme_host_port</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">_http_rewrites</span><span class="p">[</span><span class="n">from_scheme_host_port</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_http_rewrites</span><span class="p">[</span><span class="n">from_scheme_host_port</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_scheme_host_port</span>

</div>
<span class="k">def</span> <span class="nf">_hydrated</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hydration_cache</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Takes input iterable, assembles and resolves any Resource objects,</span>
<span class="sd">    returning the result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">hydration_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">hydration_cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">has_all</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Relationship</span><span class="o">.</span><span class="n">signature</span><span class="p">):</span>
            <span class="n">self_uri</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;self&quot;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">hydration_cache</span><span class="p">[</span><span class="n">self_uri</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">hydrated</span> <span class="o">=</span> <span class="n">Relationship</span><span class="o">.</span><span class="n">_hydrated</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">hydration_cache</span><span class="p">[</span><span class="n">self_uri</span><span class="p">]</span> <span class="o">=</span> <span class="n">hydrated</span>
                <span class="k">return</span> <span class="n">hydrated</span>
        <span class="k">elif</span> <span class="n">has_all</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Node</span><span class="o">.</span><span class="n">signature</span><span class="p">):</span>
            <span class="n">self_uri</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;self&quot;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">hydration_cache</span><span class="p">[</span><span class="n">self_uri</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">hydrated</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">_hydrated</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">hydration_cache</span><span class="p">[</span><span class="n">self_uri</span><span class="p">]</span> <span class="o">=</span> <span class="n">hydrated</span>
                <span class="k">return</span> <span class="n">hydrated</span>
        <span class="k">elif</span> <span class="n">has_all</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Path</span><span class="o">.</span><span class="n">signature</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Path</span><span class="o">.</span><span class="n">_hydrated</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Cannot determine object type&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">is_collection</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)([</span><span class="n">_hydrated</span><span class="p">(</span><span class="n">datum</span><span class="p">,</span> <span class="n">hydration_cache</span><span class="p">)</span> <span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">_node</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Cast the arguments provided to a :py:class:`neo4j.Node`. The following</span>
<span class="sd">    general combinations are possible:</span>

<span class="sd">    - ``node()``</span>
<span class="sd">    - ``node(node_instance)``</span>
<span class="sd">    - ``node(property_dict)``</span>
<span class="sd">    - ``node(**properties)``</span>

<span class="sd">    If :py:const:`None` is passed as the only argument, :py:const:`None` is</span>
<span class="sd">    returned instead of a ``Node`` instance.</span>

<span class="sd">    Examples::</span>

<span class="sd">        node()</span>
<span class="sd">        node(Node(&quot;http://localhost:7474/db/data/node/1&quot;))</span>
<span class="sd">        node({&quot;name&quot;: &quot;Alice&quot;})</span>
<span class="sd">        node(name=&quot;Alice&quot;)</span>

<span class="sd">    Other representations::</span>

<span class="sd">        {&quot;name&quot;: &quot;Alice&quot;}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Node</span><span class="o">.</span><span class="n">abstract</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">arg</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Node</span><span class="o">.</span><span class="n">abstract</span><span class="p">(</span><span class="o">**</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Cannot cast node from {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Cannot cast node from {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">_rel</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Cast the arguments provided to a :py:class:`neo4j.Relationship`. The</span>
<span class="sd">    following general combinations are possible:</span>

<span class="sd">    - ``rel(relationship_instance)``</span>
<span class="sd">    - ``rel((start_node, type, end_node))``</span>
<span class="sd">    - ``rel((start_node, type, end_node, properties))``</span>
<span class="sd">    - ``rel((start_node, (type, properties), end_node))``</span>
<span class="sd">    - ``rel(start_node, (type, properties), end_node)``</span>
<span class="sd">    - ``rel(start_node, type, end_node, properties)``</span>
<span class="sd">    - ``rel(start_node, type, end_node, **properties)``</span>

<span class="sd">    Examples::</span>

<span class="sd">        rel(Relationship(&quot;http://localhost:7474/db/data/relationship/1&quot;))</span>
<span class="sd">        rel((alice, &quot;KNOWS&quot;, bob))</span>
<span class="sd">        rel((alice, &quot;KNOWS&quot;, bob, {&quot;since&quot;: 1999}))</span>
<span class="sd">        rel((alice, (&quot;KNOWS&quot;, {&quot;since&quot;: 1999}), bob))</span>
<span class="sd">        rel(alice, (&quot;KNOWS&quot;, {&quot;since&quot;: 1999}), bob)</span>
<span class="sd">        rel(alice, &quot;KNOWS&quot;, bob, {&quot;since&quot;: 1999})</span>
<span class="sd">        rel(alice, &quot;KNOWS&quot;, bob, since=1999)</span>

<span class="sd">    Other representations::</span>

<span class="sd">        (alice, &quot;KNOWS&quot;, bob)</span>
<span class="sd">        (alice, &quot;KNOWS&quot;, bob, {&quot;since&quot;: 1999})</span>
<span class="sd">        (alice, (&quot;KNOWS&quot;, {&quot;since&quot;: 1999}), bob)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Relationship</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">arg</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_UnboundRelationship</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Relationship</span><span class="o">.</span><span class="n">abstract</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">**</span><span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Cannot cast relationship from {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Cannot cast relationship from {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">rel</span> <span class="o">=</span> <span class="n">_UnboundRelationship</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">rel</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rel</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">props</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Relationship</span><span class="o">.</span><span class="n">abstract</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="o">**</span><span class="n">props</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Cannot cast relationship from {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)))</span>


<span class="k">class</span> <span class="nc">Resource</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Basic RESTful web resource with JSON metadata. Wraps an</span>
<span class="sd">    `httpstream.Resource`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="n">URI</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="n">scheme_host_port</span> <span class="o">=</span> <span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scheme_host_port</span> <span class="ow">in</span> <span class="n">_http_rewrites</span><span class="p">:</span>
            <span class="n">scheme_host_port</span> <span class="o">=</span> <span class="n">_http_rewrites</span><span class="p">[</span><span class="n">scheme_host_port</span><span class="p">]</span>
            <span class="c"># This is fine - it&#39;s all my code anyway...</span>
            <span class="n">uri</span><span class="o">.</span><span class="n">_URI__set_scheme</span><span class="p">(</span><span class="n">scheme_host_port</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">uri</span><span class="o">.</span><span class="n">_URI__set_authority</span><span class="p">(</span><span class="s">&quot;{0}:{1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scheme_host_port</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                     <span class="n">scheme_host_port</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">user_info</span><span class="p">:</span>
            <span class="n">authenticate</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host_port</span><span class="p">,</span> <span class="o">*</span><span class="n">uri</span><span class="o">.</span><span class="n">user_info</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span> <span class="o">=</span> <span class="n">_Resource</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subresources</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="n">_get_headers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__uri__</span><span class="o">.</span><span class="n">host_port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_product</span> <span class="o">=</span> <span class="n">PRODUCT</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a valid Python representation of this object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Determine equality of two objects based on URI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_resource</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Determine inequality of two objects based on URI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_resource</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__uri__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span><span class="o">.</span><span class="n">__uri__</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__metadata__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_abstract</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Indicates whether this entity is abstract (i.e. not bound</span>
<span class="sd">        to a concrete entity within the database)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__uri__</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">service_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ServiceRoot</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span><span class="n">URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">graph_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_root</span><span class="o">.</span><span class="n">graph_db</span>

    <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Refresh resource metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_abstract</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">ResourceMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">()</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span>
                                      <span class="n">product</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_product</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">_ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ClientError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">_ServerError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServerError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
                                      <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span>
                                      <span class="n">product</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_product</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">_ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ClientError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">_ServerError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServerError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
                                       <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span>
                                       <span class="n">product</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_product</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">_ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ClientError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">_ServerError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServerError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span>
                                         <span class="n">product</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_product</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">_ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ClientError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">_ServerError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServerError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_subresource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subresources</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">uri</span> <span class="o">=</span> <span class="n">URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;Key {0} not found in resource &quot;</span>
                               <span class="s">&quot;metadata&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cls</span><span class="p">:</span>
                <span class="n">cls</span> <span class="o">=</span> <span class="n">Resource</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subresources</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subresources</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">ResourceMetadata</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">ResourceTemplate</span><span class="p">(</span><span class="n">_ResourceTemplate</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">values</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Resource</span><span class="p">(</span><span class="n">_ResourceTemplate</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Cacheable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">_instances</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_instance</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch a cached instance if one is available, otherwise create,</span>
<span class="sd">        cache and return a new instance.</span>

<span class="sd">        :param uri: URI of the cached resource</span>
<span class="sd">        :return: a resource instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uri</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">:</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">ServiceRoot</span><span class="p">(</span><span class="n">Cacheable</span><span class="p">,</span> <span class="n">Resource</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Neo4j REST API service root resource.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">Resource</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span> <span class="ow">or</span> <span class="n">DEFAULT_URI</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load2neo</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load2neo_checked</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">graph_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">GraphDatabaseService</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">load2neo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load2neo_checked</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load2neo</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="n">URI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="s">&quot;/load2neo&quot;</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load2neo</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">ClientError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load2neo</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load2neo_checked</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load2neo</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Load2neo extension not available&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load2neo</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">[</span><span class="s">&quot;management&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">Monitor</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">[</span><span class="s">&quot;services&quot;</span><span class="p">][</span><span class="s">&quot;monitor&quot;</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">Monitor</span><span class="p">(</span><span class="n">Cacheable</span><span class="p">,</span> <span class="n">Resource</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">uri</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="n">ServiceRoot</span><span class="p">()</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">__uri__</span>
        <span class="n">Resource</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fetch_latest_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch the latest server statistics as a list of 2-tuples, each</span>
<span class="sd">        holding a `datetime` object and a named tuple of node, relationship and</span>
<span class="sd">        property counts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;Stats&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;node_count&quot;</span><span class="p">,</span>
                                      <span class="s">&quot;relationship_count&quot;</span><span class="p">,</span>
                                      <span class="s">&quot;property_count&quot;</span><span class="p">))</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">[</span><span class="s">&quot;resources&quot;</span><span class="p">][</span><span class="s">&quot;latest_data&quot;</span><span class="p">]</span>
        <span class="n">latest_data</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="o">.</span><span class="n">_get</span><span class="p">()</span><span class="o">.</span><span class="n">content</span>
        <span class="n">timestamps</span> <span class="o">=</span> <span class="n">latest_data</span><span class="p">[</span><span class="s">&quot;timestamps&quot;</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">latest_data</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">timestamps</span><span class="p">),</span>
            <span class="p">(</span><span class="n">counts</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="p">(</span><span class="n">numberise</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;node_count&quot;</span><span class="p">]),</span>
                <span class="p">(</span><span class="n">numberise</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;relationship_count&quot;</span><span class="p">]),</span>
                <span class="p">(</span><span class="n">numberise</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;property_count&quot;</span><span class="p">]),</span>
            <span class="p">)),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>


<div class="viewcode-block" id="GraphDatabaseService"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService">[docs]</a><span class="k">class</span> <span class="nc">GraphDatabaseService</span><span class="p">(</span><span class="n">Cacheable</span><span class="p">,</span> <span class="n">Resource</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; An instance of a `Neo4j &lt;http://neo4j.org/&gt;`_ database identified by</span>
<span class="sd">    its base URI. Generally speaking, this is the only URI which a system</span>
<span class="sd">    attaching to this service should need to be directly aware of; all further</span>
<span class="sd">    entity URIs will be discovered automatically from within response content</span>
<span class="sd">    when possible (see `Hypermedia &lt;http://en.wikipedia.org/wiki/Hypermedia&gt;`_)</span>
<span class="sd">    or will be derived from existing URIs.</span>

<span class="sd">    The following code illustrates how to connect to a database server and</span>
<span class="sd">    display its version number::</span>

<span class="sd">        from py2neo import neo4j</span>
<span class="sd">        </span>
<span class="sd">        graph_db = neo4j.GraphDatabaseService()</span>
<span class="sd">        print(graph_db.neo4j_version)</span>

<span class="sd">    :param uri: the base URI of the database (defaults to &lt;http://localhost:7474/db/data/&gt;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">uri</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="n">ServiceRoot</span><span class="p">()</span><span class="o">.</span><span class="n">graph_db</span><span class="o">.</span><span class="n">__uri__</span>
        <span class="n">Resource</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indexes</span> <span class="o">=</span> <span class="p">{</span><span class="n">Node</span><span class="p">:</span> <span class="p">{},</span> <span class="n">Relationship</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the size of this graph (i.e. the number of relationships).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_load2neo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_root</span><span class="o">.</span><span class="n">load2neo</span>

<div class="viewcode-block" id="GraphDatabaseService.clear"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clear all nodes and relationships from the graph.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This method will permanently remove **all** nodes and relationships</span>
<span class="sd">            from the graph and cannot be undone.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">WriteBatch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append_cypher</span><span class="p">(</span><span class="s">&quot;START r=rel(*) DELETE r&quot;</span><span class="p">)</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append_cypher</span><span class="p">(</span><span class="s">&quot;START n=node(*) DELETE n&quot;</span><span class="p">)</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="GraphDatabaseService.create"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">abstracts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create multiple nodes and/or relationships as part of a single</span>
<span class="sd">        batch.</span>

<span class="sd">        The abstracts provided may use any accepted notation, as described in</span>
<span class="sd">        the section on py2neo fundamentals.</span>
<span class="sd">        For a node, simply pass a dictionary of properties; for a relationship, pass a tuple of</span>
<span class="sd">        (start, type, end) or (start, type, end, data) where start and end</span>
<span class="sd">        may be :py:class:`Node` instances or zero-based integral references</span>
<span class="sd">        to other node entities within this batch::</span>

<span class="sd">            # create a single node</span>
<span class="sd">            alice, = graph_db.create({&quot;name&quot;: &quot;Alice&quot;})</span>

<span class="sd">            # create multiple nodes</span>
<span class="sd">            people = graph_db.create(</span>
<span class="sd">                {&quot;name&quot;: &quot;Alice&quot;, &quot;age&quot;: 33}, {&quot;name&quot;: &quot;Bob&quot;, &quot;age&quot;: 44},</span>
<span class="sd">                {&quot;name&quot;: &quot;Carol&quot;, &quot;age&quot;: 55}, {&quot;name&quot;: &quot;Dave&quot;, &quot;age&quot;: 66},</span>
<span class="sd">            )</span>

<span class="sd">            # create two nodes with a connecting relationship</span>
<span class="sd">            alice, bob, rel = graph_db.create(</span>
<span class="sd">                {&quot;name&quot;: &quot;Alice&quot;}, {&quot;name&quot;: &quot;Bob&quot;},</span>
<span class="sd">                (0, &quot;KNOWS&quot;, 1, {&quot;since&quot;: 2006})</span>
<span class="sd">            )</span>

<span class="sd">            # create a node plus a relationship to pre-existing node</span>
<span class="sd">            ref_node = graph_db.get_reference_node()</span>
<span class="sd">            alice, rel = graph_db.create(</span>
<span class="sd">                {&quot;name&quot;: &quot;Alice&quot;}, (ref_node, &quot;PERSON&quot;, 0)</span>
<span class="sd">            )</span>

<span class="sd">        :return: list of :py:class:`Node` and/or :py:class:`Relationship`</span>
<span class="sd">            instances</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This method will *always* return a list, even when only creating</span>
<span class="sd">            a single node or relationship. To automatically unpack a list</span>
<span class="sd">            containing a single item, append a trailing comma to the variable</span>
<span class="sd">            name on the left of the assignment operation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">abstracts</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">WriteBatch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">abstract</span> <span class="ow">in</span> <span class="n">abstracts</span><span class="p">:</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">abstract</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">batch</span><span class="o">.</span><span class="n">submit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="GraphDatabaseService.delete"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">entities</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete multiple nodes and/or relationships as part of a single</span>
<span class="sd">        batch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entities</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">WriteBatch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="GraphDatabaseService.find"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.find">[docs]</a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">property_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">property_value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate through a set of labelled nodes, optionally filtering</span>
<span class="sd">        by property key and value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="n">URI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;label&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s">&quot;nodes&quot;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">property_key</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="s">&quot;?&quot;</span> <span class="o">+</span> <span class="n">percent_encode</span><span class="p">({</span><span class="n">property_key</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">property_value</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)}))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">(</span><span class="n">Resource</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="o">.</span><span class="n">_get</span><span class="p">()):</span>
                <span class="k">yield</span> <span class="n">_hydrated</span><span class="p">(</span><span class="n">assembled</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">NOT_FOUND</span><span class="p">:</span>
                <span class="k">raise</span>
</div>
<div class="viewcode-block" id="GraphDatabaseService.get_properties"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.get_properties">[docs]</a>    <span class="k">def</span> <span class="nf">get_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">entities</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch properties for multiple nodes and/or relationships as part</span>
<span class="sd">        of a single batch; returns a list of dictionaries in the same order</span>
<span class="sd">        as the supplied entities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entities</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">entities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_properties</span><span class="p">()]</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">BatchRequestList</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">append_get</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s">&quot;properties&quot;</span><span class="p">))</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">_execute</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">BatchResponse</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">body</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="n">responses</span><span class="o">.</span><span class="n">json</span><span class="p">]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">responses</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="GraphDatabaseService.load_geoff"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.load_geoff">[docs]</a>    <span class="k">def</span> <span class="nf">load_geoff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geoff</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Load Geoff data via the load2neo extension.</span>

<span class="sd">        ::</span>

<span class="sd">            &gt;&gt;&gt; from py2neo import neo4j</span>
<span class="sd">            &gt;&gt;&gt; graph_db = neo4j.GraphDatabaseService()</span>
<span class="sd">            &gt;&gt;&gt; graph_db.load_geoff(&quot;(alice)&lt;-[:KNOWS]-&gt;(bob)&quot;)</span>
<span class="sd">            [{u&#39;alice&#39;: Node(&#39;http://localhost:7474/db/data/node/1&#39;),</span>
<span class="sd">              u&#39;bob&#39;: Node(&#39;http://localhost:7474/db/data/node/2&#39;)}]</span>

<span class="sd">        :param geoff: geoff data to load</span>
<span class="sd">        :return: list of node mappings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_load2neo</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">[</span><span class="s">&quot;geoff_loader&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="nb">dict</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">loader</span><span class="o">.</span><span class="n">_post</span><span class="p">(</span><span class="n">geoff</span><span class="p">)</span><span class="o">.</span><span class="n">tsj</span>
        <span class="p">]</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="GraphDatabaseService.load2neo_version"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.load2neo_version">[docs]</a>    <span class="k">def</span> <span class="nf">load2neo_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The load2neo extension version, if available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">version_tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_load2neo</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">[</span><span class="s">&quot;load2neo_version&quot;</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="GraphDatabaseService.match"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.match">[docs]</a>    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_node</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rel_type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">end_node</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
              <span class="n">bidirectional</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate through all relationships matching specified criteria.</span>

<span class="sd">        Examples are as follows::</span>

<span class="sd">            # all relationships from the graph database</span>
<span class="sd">            # ()-[r]-()</span>
<span class="sd">            rels = list(graph_db.match())</span>

<span class="sd">            # all relationships outgoing from `alice`</span>
<span class="sd">            # (alice)-[r]-&gt;()</span>
<span class="sd">            rels = list(graph_db.match(start_node=alice))</span>

<span class="sd">            # all relationships incoming to `alice`</span>
<span class="sd">            # ()-[r]-&gt;(alice)</span>
<span class="sd">            rels = list(graph_db.match(end_node=alice))</span>

<span class="sd">            # all relationships attached to `alice`, regardless of direction</span>
<span class="sd">            # (alice)-[r]-()</span>
<span class="sd">            rels = list(graph_db.match(start_node=alice, bidirectional=True))</span>

<span class="sd">            # all relationships from `alice` to `bob`</span>
<span class="sd">            # (alice)-[r]-&gt;(bob)</span>
<span class="sd">            rels = list(graph_db.match(start_node=alice, end_node=bob))</span>

<span class="sd">            # all relationships outgoing from `alice` of type &quot;FRIEND&quot;</span>
<span class="sd">            # (alice)-[r:FRIEND]-&gt;()</span>
<span class="sd">            rels = list(graph_db.match(start_node=alice, rel_type=&quot;FRIEND&quot;))</span>

<span class="sd">            # up to three relationships outgoing from `alice` of type &quot;FRIEND&quot;</span>
<span class="sd">            # (alice)-[r:FRIEND]-&gt;()</span>
<span class="sd">            rels = list(graph_db.match(start_node=alice, rel_type=&quot;FRIEND&quot;, limit=3))</span>

<span class="sd">        :param start_node: concrete start :py:class:`Node` to match or</span>
<span class="sd">            :py:const:`None` if any</span>
<span class="sd">        :param rel_type: type of relationships to match or :py:const:`None` if</span>
<span class="sd">            any</span>
<span class="sd">        :param end_node: concrete end :py:class:`Node` to match or</span>
<span class="sd">            :py:const:`None` if any</span>
<span class="sd">        :param bidirectional: :py:const:`True` if reversed relationships should</span>
<span class="sd">            also be included</span>
<span class="sd">        :param limit: maximum number of relationships to match or</span>
<span class="sd">            :py:const:`None` if no limit</span>
<span class="sd">        :return: matching relationships</span>
<span class="sd">        :rtype: generator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">start_node</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">end_node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;START a=node(*)&quot;</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="n">end_node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;START a=node({A})&quot;</span>
            <span class="n">start_node</span> <span class="o">=</span> <span class="n">_cast</span><span class="p">(</span><span class="n">start_node</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">abstract</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;A&quot;</span><span class="p">:</span> <span class="n">start_node</span><span class="o">.</span><span class="n">_id</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">start_node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;START b=node({B})&quot;</span>
            <span class="n">end_node</span> <span class="o">=</span> <span class="n">_cast</span><span class="p">(</span><span class="n">end_node</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">abstract</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;B&quot;</span><span class="p">:</span> <span class="n">end_node</span><span class="o">.</span><span class="n">_id</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;START a=node({A}),b=node({B})&quot;</span>
            <span class="n">start_node</span> <span class="o">=</span> <span class="n">_cast</span><span class="p">(</span><span class="n">start_node</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">abstract</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">end_node</span> <span class="o">=</span> <span class="n">_cast</span><span class="p">(</span><span class="n">end_node</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">abstract</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;A&quot;</span><span class="p">:</span> <span class="n">start_node</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="s">&quot;B&quot;</span><span class="p">:</span> <span class="n">end_node</span><span class="o">.</span><span class="n">_id</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">rel_type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rel_clause</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">is_collection</span><span class="p">(</span><span class="n">rel_type</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neo4j_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c"># yuk, version sniffing :-(</span>
                <span class="n">separator</span> <span class="o">=</span> <span class="s">&quot;|:&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">separator</span> <span class="o">=</span> <span class="s">&quot;|&quot;</span>
            <span class="n">rel_clause</span> <span class="o">=</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;`{0}`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
                                              <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">rel_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rel_clause</span> <span class="o">=</span> <span class="s">&quot;:`{0}`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rel_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bidirectional</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s">&quot; MATCH (a)-[r&quot;</span> <span class="o">+</span> <span class="n">rel_clause</span> <span class="o">+</span> <span class="s">&quot;]-(b) RETURN r&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s">&quot; MATCH (a)-[r&quot;</span> <span class="o">+</span> <span class="n">rel_clause</span> <span class="o">+</span> <span class="s">&quot;]-&gt;(b) RETURN r&quot;</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s">&quot; LIMIT {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">limit</span><span class="p">))</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">CypherQuery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="GraphDatabaseService.match_one"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.match_one">[docs]</a>    <span class="k">def</span> <span class="nf">match_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_node</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rel_type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">end_node</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">bidirectional</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch a single relationship matching specified criteria.</span>

<span class="sd">        :param start_node: concrete start :py:class:`Node` to match or</span>
<span class="sd">            :py:const:`None` if any</span>
<span class="sd">        :param rel_type: type of relationships to match or :py:const:`None` if</span>
<span class="sd">            any</span>
<span class="sd">        :param end_node: concrete end :py:class:`Node` to match or</span>
<span class="sd">            :py:const:`None` if any</span>
<span class="sd">        :param bidirectional: :py:const:`True` if reversed relationships should</span>
<span class="sd">            also be included</span>
<span class="sd">        :return: a matching :py:class:`Relationship` or :py:const:`None`</span>

<span class="sd">        .. seealso::</span>
<span class="sd">           :py:func:`GraphDatabaseService.match &lt;py2neo.neo4j.GraphDatabaseService.match&gt;`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">start_node</span><span class="p">,</span> <span class="n">rel_type</span><span class="p">,</span> <span class="n">end_node</span><span class="p">,</span>
                               <span class="n">bidirectional</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">rels</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="GraphDatabaseService.neo4j_version"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.neo4j_version">[docs]</a>    <span class="k">def</span> <span class="nf">neo4j_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The database software version as a 4-tuple of (``int``, ``int``,</span>
<span class="sd">        ``int``, ``str``).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">version_tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">[</span><span class="s">&quot;neo4j_version&quot;</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="GraphDatabaseService.node"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.node">[docs]</a>    <span class="k">def</span> <span class="nf">node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch a node by ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Node</span><span class="p">(</span><span class="n">URI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="s">&quot;node/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_</span><span class="p">)))</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="GraphDatabaseService.node_labels"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.node_labels">[docs]</a>    <span class="k">def</span> <span class="nf">node_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The set of node labels currently defined within the graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="n">URI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="s">&quot;labels&quot;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">_hydrated</span><span class="p">(</span><span class="n">assembled</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">_get</span><span class="p">())))</span>
        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">NOT_FOUND</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Node labels not available for this &quot;</span>
                                          <span class="s">&quot;Neo4j server version&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="GraphDatabaseService.order"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.order">[docs]</a>    <span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The number of nodes in this graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">CypherQuery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;START n=node(*) &quot;</span>
                                 <span class="s">&quot;RETURN count(n)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execute_one</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="GraphDatabaseService.relationship"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.relationship">[docs]</a>    <span class="k">def</span> <span class="nf">relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch a relationship by ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Relationship</span><span class="p">(</span><span class="n">URI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="s">&quot;relationship/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_</span><span class="p">)))</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="GraphDatabaseService.relationship_types"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.relationship_types">[docs]</a>    <span class="k">def</span> <span class="nf">relationship_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The set of relationship types currently defined within the graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subresource</span><span class="p">(</span><span class="s">&quot;relationship_types&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">_hydrated</span><span class="p">(</span><span class="n">assembled</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">_get</span><span class="p">())))</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="GraphDatabaseService.schema"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.schema">[docs]</a>    <span class="k">def</span> <span class="nf">schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The Schema resource for this graph.</span>

<span class="sd">        .. seealso::</span>
<span class="sd">            :py:func:`Schema &lt;py2neo.neo4j.Schema&gt;`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Schema</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span><span class="n">URI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="s">&quot;schema&quot;</span><span class="p">))</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="GraphDatabaseService.size"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.size">[docs]</a>    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The number of relationships in this graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">CypherQuery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;START r=rel(*) &quot;</span>
                                 <span class="s">&quot;RETURN count(r)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execute_one</span><span class="p">()</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">supports_foreach_pipe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Indicates whether the server supports pipe syntax for FOREACH.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">neo4j_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="GraphDatabaseService.supports_index_uniqueness_modes"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.supports_index_uniqueness_modes">[docs]</a>    <span class="k">def</span> <span class="nf">supports_index_uniqueness_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Indicates whether the server supports `get_or_create` and</span>
<span class="sd">        `create_or_fail` uniqueness modes on batched index methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">neo4j_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="GraphDatabaseService.supports_node_labels"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.supports_node_labels">[docs]</a>    <span class="k">def</span> <span class="nf">supports_node_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Indicates whether the server supports node labels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">neo4j_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">supports_optional_match</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Indicates whether the server supports Cypher OPTIONAL MATCH</span>
<span class="sd">        clauses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">neo4j_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="GraphDatabaseService.supports_schema_indexes"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.supports_schema_indexes">[docs]</a>    <span class="k">def</span> <span class="nf">supports_schema_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Indicates whether the server supports schema indexes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">neo4j_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">supports_cypher_transactions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Indicates whether the server supports explicit Cypher transactions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&quot;transaction&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata__</span>

    <span class="k">def</span> <span class="nf">_index_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch the index management resource for the given `content_type`.</span>

<span class="sd">        :param content_type:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">content_type</span> <span class="ow">is</span> <span class="n">Node</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">[</span><span class="s">&quot;node_index&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">content_type</span> <span class="ow">is</span> <span class="n">Relationship</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">[</span><span class="s">&quot;relationship_index&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IndexTypeError</span><span class="p">(</span><span class="n">content_type</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Resource</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>

<div class="viewcode-block" id="GraphDatabaseService.get_indexes"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.get_indexes">[docs]</a>    <span class="k">def</span> <span class="nf">get_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch a dictionary of all available indexes of a given type.</span>

<span class="sd">        :param content_type: either :py:class:`neo4j.Node` or</span>
<span class="sd">            :py:class:`neo4j.Relationship`</span>
<span class="sd">        :return: a list of :py:class:`Index` instances of the specified type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_manager</span><span class="p">(</span><span class="n">content_type</span><span class="p">)</span>
        <span class="n">index_index</span> <span class="o">=</span> <span class="n">index_manager</span><span class="o">.</span><span class="n">_get</span><span class="p">()</span><span class="o">.</span><span class="n">content</span>
        <span class="k">if</span> <span class="n">index_index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indexes</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Index</span><span class="p">(</span><span class="n">content_type</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="s">&quot;template&quot;</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">index_index</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indexes</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexes</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="GraphDatabaseService.get_index"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.get_index">[docs]</a>    <span class="k">def</span> <span class="nf">get_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">index_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch a specific index from the current database, returning an</span>
<span class="sd">        :py:class:`Index` instance. If an index with the supplied `name` and</span>
<span class="sd">        content `type` does not exist, :py:const:`None` is returned.</span>

<span class="sd">        :param content_type: either :py:class:`neo4j.Node` or</span>
<span class="sd">            :py:class:`neo4j.Relationship`</span>
<span class="sd">        :param index_name: the name of the required index</span>
<span class="sd">        :return: an :py:class:`Index` instance or :py:const:`None`</span>

<span class="sd">        .. seealso:: :py:func:`get_or_create_index`</span>
<span class="sd">        .. seealso:: :py:class:`Index`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexes</span><span class="p">[</span><span class="n">content_type</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_indexes</span><span class="p">(</span><span class="n">content_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexes</span><span class="p">[</span><span class="n">content_type</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexes</span><span class="p">[</span><span class="n">content_type</span><span class="p">][</span><span class="n">index_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="GraphDatabaseService.get_or_create_index"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.get_or_create_index">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_create_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch a specific index from the current database, returning an</span>
<span class="sd">        :py:class:`Index` instance. If an index with the supplied `name` and</span>
<span class="sd">        content `type` does not exist, one is created with either the</span>
<span class="sd">        default configuration or that supplied in `config`::</span>

<span class="sd">            # get or create a node index called &quot;People&quot;</span>
<span class="sd">            people = graph_db.get_or_create_index(neo4j.Node, &quot;People&quot;)</span>

<span class="sd">            # get or create a relationship index called &quot;Friends&quot;</span>
<span class="sd">            friends = graph_db.get_or_create_index(neo4j.Relationship, &quot;Friends&quot;)</span>

<span class="sd">        :param content_type: either :py:class:`neo4j.Node` or</span>
<span class="sd">            :py:class:`neo4j.Relationship`</span>
<span class="sd">        :param index_name: the name of the required index</span>
<span class="sd">        :return: an :py:class:`Index` instance</span>

<span class="sd">        .. seealso:: :py:func:`get_index`</span>
<span class="sd">        .. seealso:: :py:class:`Index`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">content_type</span><span class="p">,</span> <span class="n">index_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">index</span>
        <span class="n">index_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_manager</span><span class="p">(</span><span class="n">content_type</span><span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">index_manager</span><span class="o">.</span><span class="n">_post</span><span class="p">({</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="n">index_name</span><span class="p">,</span> <span class="s">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span> <span class="ow">or</span> <span class="p">{}})</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">Index</span><span class="p">(</span><span class="n">content_type</span><span class="p">,</span> <span class="n">assembled</span><span class="p">(</span><span class="n">rs</span><span class="p">)[</span><span class="s">&quot;template&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indexes</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">index_name</span><span class="p">:</span> <span class="n">index</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">index</span>
</div>
<div class="viewcode-block" id="GraphDatabaseService.delete_index"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.delete_index">[docs]</a>    <span class="k">def</span> <span class="nf">delete_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">index_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete the entire index identified by the type and name supplied.</span>

<span class="sd">        :param content_type: either :py:class:`neo4j.Node` or</span>
<span class="sd">            :py:class:`neo4j.Relationship`</span>
<span class="sd">        :param index_name: the name of the index to delete</span>
<span class="sd">        :raise LookupError: if the specified index does not exist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexes</span><span class="p">[</span><span class="n">content_type</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_indexes</span><span class="p">(</span><span class="n">content_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexes</span><span class="p">[</span><span class="n">content_type</span><span class="p">]:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexes</span><span class="p">[</span><span class="n">content_type</span><span class="p">][</span><span class="n">index_name</span><span class="p">]</span>
            <span class="n">index</span><span class="o">.</span><span class="n">_delete</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexes</span><span class="p">[</span><span class="n">content_type</span><span class="p">][</span><span class="n">index_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s">&quot;Index not found&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GraphDatabaseService.get_indexed_node"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.get_indexed_node">[docs]</a>    <span class="k">def</span> <span class="nf">get_indexed_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch the first node indexed with the specified details, returning</span>
<span class="sd">        :py:const:`None` if none found.</span>

<span class="sd">        :param index_name: the name of the required index</span>
<span class="sd">        :param key: the index key</span>
<span class="sd">        :param value: the index value</span>
<span class="sd">        :return: a :py:class:`Node` instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">index_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span><span class="p">:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="GraphDatabaseService.get_or_create_indexed_node"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.get_or_create_indexed_node">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_create_indexed_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch the first node indexed with the specified details, creating</span>
<span class="sd">        and returning a new indexed node if none found.</span>

<span class="sd">        :param index_name: the name of the required index</span>
<span class="sd">        :param key: the index key</span>
<span class="sd">        :param value: the index value</span>
<span class="sd">        :param properties: properties for the new node, if one is created</span>
<span class="sd">            (optional)</span>
<span class="sd">        :return: a :py:class:`Node` instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_or_create_index</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">index_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">index</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">properties</span> <span class="ow">or</span> <span class="p">{})</span>
</div>
<div class="viewcode-block" id="GraphDatabaseService.get_indexed_relationship"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.GraphDatabaseService.get_indexed_relationship">[docs]</a>    <span class="k">def</span> <span class="nf">get_indexed_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch the first relationship indexed with the specified details,</span>
<span class="sd">        returning :py:const:`None` if none found.</span>

<span class="sd">        :param index_name: the name of the required index</span>
<span class="sd">        :param key: the index key</span>
<span class="sd">        :param value: the index value</span>
<span class="sd">        :return: a :py:class:`Relationship` instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">Relationship</span><span class="p">,</span> <span class="n">index_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span><span class="p">:</span>
            <span class="n">relationships</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">relationships</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">relationships</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">None</span>

</div></div>
<div class="viewcode-block" id="CypherQuery"><a class="viewcode-back" href="../../../cypher/#py2neo.neo4j.CypherQuery">[docs]</a><span class="k">class</span> <span class="nc">CypherQuery</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A reusable Cypher query. To create a new query object, a graph and the</span>
<span class="sd">    query text need to be supplied::</span>

<span class="sd">        &gt;&gt;&gt; from py2neo import neo4j</span>
<span class="sd">        &gt;&gt;&gt; graph_db = neo4j.GraphDatabaseService()</span>
<span class="sd">        &gt;&gt;&gt; query = neo4j.CypherQuery(graph_db, &quot;CREATE (a) RETURN a&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_db</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cypher</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="n">graph_db</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">[</span><span class="s">&quot;cypher&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span> <span class="o">=</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="CypherQuery.string"><a class="viewcode-back" href="../../../cypher/#py2neo.neo4j.CypherQuery.string">[docs]</a>    <span class="k">def</span> <span class="nf">string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The text of the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span>
</div>
    <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="n">cypher_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Query: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
                <span class="n">cypher_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Params: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cypher</span><span class="o">.</span><span class="n">_post</span><span class="p">({</span>
                <span class="s">&quot;query&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">,</span>
                <span class="s">&quot;params&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{}),</span>
            <span class="p">})</span>
        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="p">:</span>
                <span class="c"># A CustomCypherError is a dynamically created subclass of</span>
                <span class="c"># CypherError with the same name as the underlying server</span>
                <span class="c"># exception</span>
                <span class="n">CustomCypherError</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="p">),</span> <span class="p">(</span><span class="n">CypherError</span><span class="p">,),</span> <span class="p">{})</span>
                <span class="k">raise</span> <span class="n">CustomCypherError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CypherError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<div class="viewcode-block" id="CypherQuery.run"><a class="viewcode-back" href="../../../cypher/#py2neo.neo4j.CypherQuery.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Execute the query and discard any results.</span>

<span class="sd">        :param params:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="CypherQuery.execute"><a class="viewcode-back" href="../../../cypher/#py2neo.neo4j.CypherQuery.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Execute the query and return the results.</span>

<span class="sd">        :param params:</span>
<span class="sd">        :return:</span>
<span class="sd">        :rtype: :py:class:`CypherResults &lt;py2neo.neo4j.CypherResults&gt;`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">CypherResults</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="CypherQuery.execute_one"><a class="viewcode-back" href="../../../cypher/#py2neo.neo4j.CypherQuery.execute_one">[docs]</a>    <span class="k">def</span> <span class="nf">execute_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Execute the query and return the first value from the first row.</span>

<span class="sd">        :param params:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="CypherQuery.stream"><a class="viewcode-back" href="../../../cypher/#py2neo.neo4j.CypherQuery.stream">[docs]</a>    <span class="k">def</span> <span class="nf">stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Execute the query and return a result iterator.</span>

<span class="sd">        :param params:</span>
<span class="sd">        :return:</span>
<span class="sd">        :rtype: :py:class:`IterableCypherResults &lt;py2neo.neo4j.IterableCypherResults&gt;`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">IterableCypherResults</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="CypherResults"><a class="viewcode-back" href="../../../cypher/#py2neo.neo4j.CypherResults">[docs]</a><span class="k">class</span> <span class="nc">CypherResults</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A static set of results from a Cypher query.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">signature</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;columns&quot;</span><span class="p">,</span> <span class="s">&quot;data&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_hydrated</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">hydration_cache</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Takes assembled data...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">producer</span> <span class="o">=</span> <span class="n">RecordProducer</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;columns&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">producer</span><span class="o">.</span><span class="n">produce</span><span class="p">(</span><span class="n">_hydrated</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">hydration_cache</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">]</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="s">&quot;columns&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_producer</span> <span class="o">=</span> <span class="n">RecordProducer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_producer</span><span class="o">.</span><span class="n">produce</span><span class="p">(</span><span class="n">_hydrated</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">content</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">]</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="CypherResults.columns"><a class="viewcode-back" href="../../../cypher/#py2neo.neo4j.CypherResults.columns">[docs]</a>    <span class="k">def</span> <span class="nf">columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Column names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="CypherResults.data"><a class="viewcode-back" href="../../../cypher/#py2neo.neo4j.CypherResults.data">[docs]</a>    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; List of result records.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</div>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="IterableCypherResults"><a class="viewcode-back" href="../../../cypher/#py2neo.neo4j.IterableCypherResults">[docs]</a><span class="k">class</span> <span class="nc">IterableCypherResults</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; An iterable set of results from a Cypher query.</span>

<span class="sd">    ::</span>

<span class="sd">        query = graph_db.cypher.query(&quot;START n=node(*) RETURN n LIMIT 10&quot;)</span>
<span class="sd">        for record in query.stream():</span>
<span class="sd">            print record[0]</span>

<span class="sd">    Each record returned is cast into a :py:class:`namedtuple` with names</span>
<span class="sd">    derived from the resulting column names.</span>

<span class="sd">    .. note ::</span>
<span class="sd">        Results are available as returned from the server and are decoded</span>
<span class="sd">        incrementally. This means that there is no need to wait for the</span>
<span class="sd">        entire response to be received before processing can occur.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span> <span class="o">=</span> <span class="n">response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_redo_buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffered_results</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_columns</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_producer</span> <span class="o">=</span> <span class="n">RecordProducer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fetch_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">redo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">section</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffered</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;columns&quot;</span><span class="p">:</span>
                <span class="n">section</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">redo</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;data&quot;</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_redo_buffer</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">redo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">assembled</span><span class="p">(</span><span class="n">section</span><span class="p">)[</span><span class="s">&quot;columns&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_buffered_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redo_buffer</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redo_buffer</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hydration_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffered</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;data&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">(</span><span class="n">section</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_producer</span><span class="o">.</span><span class="n">produce</span><span class="p">(</span><span class="n">_hydrated</span><span class="p">(</span><span class="n">assembled</span><span class="p">(</span><span class="n">row</span><span class="p">),</span>
                                                           <span class="n">hydration_cache</span><span class="p">))</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="IterableCypherResults.columns"><a class="viewcode-back" href="../../../cypher/#py2neo.neo4j.IterableCypherResults.columns">[docs]</a>    <span class="k">def</span> <span class="nf">columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Column names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span>
</div>
<div class="viewcode-block" id="IterableCypherResults.close"><a class="viewcode-back" href="../../../cypher/#py2neo.neo4j.IterableCypherResults.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Close results and free resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="Schema"><a class="viewcode-back" href="../../../schema/#py2neo.neo4j.Schema">[docs]</a><span class="k">class</span> <span class="nc">Schema</span><span class="p">(</span><span class="n">Cacheable</span><span class="p">,</span> <span class="n">Resource</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">Resource</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_root</span><span class="o">.</span><span class="n">graph_db</span><span class="o">.</span><span class="n">supports_schema_indexes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Schema index support requires &quot;</span>
                                      <span class="s">&quot;version 2.0 or above&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_template</span> <span class="o">=</span> \
            <span class="n">URITemplate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">URI</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;/index/{label}&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_key_template</span> <span class="o">=</span> \
            <span class="n">URITemplate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">URI</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;/index/{label}/{property_key}&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Schema.get_indexed_property_keys"><a class="viewcode-back" href="../../../schema/#py2neo.neo4j.Schema.get_indexed_property_keys">[docs]</a>    <span class="k">def</span> <span class="nf">get_indexed_property_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch a list of indexed property keys for a label.</span>

<span class="sd">        :param label:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">label</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Label cannot be empty&quot;</span><span class="p">)</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_template</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">_get</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">NOT_FOUND</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">indexed</span><span class="p">[</span><span class="s">&quot;property_keys&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">indexed</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span>
            <span class="p">]</span>
</div>
<div class="viewcode-block" id="Schema.create_index"><a class="viewcode-back" href="../../../schema/#py2neo.neo4j.Schema.create_index">[docs]</a>    <span class="k">def</span> <span class="nf">create_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">property_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Index a property key for a label.</span>

<span class="sd">        :param label:</span>
<span class="sd">        :param property_key:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">label</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">property_key</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Neither label nor property key can be empty&quot;</span><span class="p">)</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_template</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
        <span class="n">property_key</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">property_key</span><span class="p">,</span> <span class="s">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">_post</span><span class="p">({</span><span class="s">&quot;property_keys&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">property_key</span><span class="p">]})</span>
        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">CONFLICT</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Property key already indexed&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
</div>
<div class="viewcode-block" id="Schema.drop_index"><a class="viewcode-back" href="../../../schema/#py2neo.neo4j.Schema.drop_index">[docs]</a>    <span class="k">def</span> <span class="nf">drop_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">property_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove label index for a given property key.</span>

<span class="sd">        :param label:</span>
<span class="sd">        :param property_key:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">label</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">property_key</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Neither label nor property key can be empty&quot;</span><span class="p">)</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_key_template</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                              <span class="n">property_key</span><span class="o">=</span><span class="n">property_key</span><span class="p">)</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">_delete</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">NOT_FOUND</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s">&quot;Property key not found&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

</div></div>
<span class="k">class</span> <span class="nc">_Entity</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Base class from which :py:class:`Node` and :py:class:`Relationship`</span>
<span class="sd">    classes inherit. Provides property management functionality by defining</span>
<span class="sd">    standard Python container handler methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
        <span class="n">Resource</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_properties</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_properties</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="bp">None</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_properties</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_properties</span><span class="p">()</span><span class="o">.</span><span class="n">__iter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_properties</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_properties</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_properties_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subresource</span><span class="p">(</span><span class="s">&quot;properties&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the internal ID for this entity.</span>

<span class="sd">        :return: integer ID of this entity within the database or</span>
<span class="sd">            :py:const:`None` if abstract</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_abstract</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">URI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete this entity from the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Detects whether this entity still exists in the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">NOT_FOUND</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">get_cached_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch last known properties without calling the server.</span>

<span class="sd">        :return: dictionary of properties</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_abstract</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch all properties.</span>

<span class="sd">        :return: dictionary of properties</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_abstract</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="n">assembled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties_resource</span><span class="o">.</span><span class="n">_get</span><span class="p">())</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span>

    <span class="k">def</span> <span class="nf">set_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Replace all properties with those supplied.</span>

<span class="sd">        :param properties: dictionary of new properties</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_abstract</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_properties_resource</span><span class="o">.</span><span class="n">_put</span><span class="p">(</span><span class="n">compact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_properties_resource</span><span class="o">.</span><span class="n">_delete</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">delete_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete all properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_properties</span><span class="p">({})</span>

    <span class="k">def</span> <span class="nf">update_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;_Entity.update_properties&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="Node"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Node">[docs]</a><span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">_Entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A node within a graph, identified by a URI. For example:</span>

<span class="sd">        &gt;&gt;&gt; from py2neo import neo4j</span>
<span class="sd">        &gt;&gt;&gt; alice = neo4j.Node(&quot;http://localhost:7474/db/data/node/1&quot;)</span>

<span class="sd">    Typically, concrete nodes will not be constructed directly in this way</span>
<span class="sd">    by client applications. Instead, methods such as</span>
<span class="sd">    :py:func:`GraphDatabaseService.create` build node objects indirectly as</span>
<span class="sd">    required. Once created, nodes can be treated like any other container type</span>
<span class="sd">    so as to manage properties::</span>

<span class="sd">        # get the `name` property of `node`</span>
<span class="sd">        name = node[&quot;name&quot;]</span>

<span class="sd">        # set the `name` property of `node` to `Alice`</span>
<span class="sd">        node[&quot;name&quot;] = &quot;Alice&quot;</span>

<span class="sd">        # delete the `name` property from `node`</span>
<span class="sd">        del node[&quot;name&quot;]</span>

<span class="sd">        # determine the number of properties within `node`</span>
<span class="sd">        count = len(node)</span>

<span class="sd">        # determine existence of the `name` property within `node`</span>
<span class="sd">        if &quot;name&quot; in node:</span>
<span class="sd">            pass</span>

<span class="sd">        # iterate through property keys in `node`</span>
<span class="sd">        for key in node:</span>
<span class="sd">            value = node[key]</span>

<span class="sd">    :param uri: URI identifying this node</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">signature</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;self&quot;</span><span class="p">,)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_hydrated</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;self&quot;</span><span class="p">])</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">ResourceMetadata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Node.abstract"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Node.abstract">[docs]</a>    <span class="k">def</span> <span class="nf">abstract</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">properties</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create and return a new abstract node containing properties drawn</span>
<span class="sd">        from the keyword arguments supplied. An abstract node is not bound to</span>
<span class="sd">        a concrete node within a database but properties can be managed</span>
<span class="sd">        similarly to those within bound nodes::</span>

<span class="sd">            &gt;&gt;&gt; alice = Node.abstract(name=&quot;Alice&quot;)</span>
<span class="sd">            &gt;&gt;&gt; alice[&quot;name&quot;]</span>
<span class="sd">            &#39;Alice&#39;</span>
<span class="sd">            &gt;&gt;&gt; alice[&quot;age&quot;] = 34</span>
<span class="sd">            alice.get_properties()</span>
<span class="sd">            {&#39;age&#39;: 34, &#39;name&#39;: &#39;Alice&#39;}</span>

<span class="sd">        If more complex property keys are required, abstract nodes may be</span>
<span class="sd">        instantiated with the ``**`` syntax::</span>

<span class="sd">            &gt;&gt;&gt; alice = Node.abstract(**{&quot;first name&quot;: &quot;Alice&quot;})</span>
<span class="sd">            &gt;&gt;&gt; alice[&quot;first name&quot;]</span>
<span class="sd">            &#39;Alice&#39;</span>

<span class="sd">        :param properties: node properties</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span>
</div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
        <span class="n">_Entity</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">_cast</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__uri__</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_Entity</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_properties</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">_cast</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__uri__</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_Entity</span><span class="o">.</span><span class="n">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_properties</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_abstract</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;{0}({1})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                <span class="nb">repr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__uri__</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;node({1})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;node()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
            <span class="p">)</span>

<div class="viewcode-block" id="Node.__str__"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Node.__str__">[docs]</a>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return Cypher/Geoff style representation of this node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_abstract</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;({0})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;({0} {1})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;({0})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_abstract</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__uri__</span><span class="p">)</span>

<div class="viewcode-block" id="Node.delete_related"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Node.delete_related">[docs]</a>    <span class="k">def</span> <span class="nf">delete_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete this node along with all related nodes and relationships.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_db</span><span class="o">.</span><span class="n">supports_foreach_pipe</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;START a=node({a}) &quot;</span>
                     <span class="s">&quot;MATCH (a)-[rels*0..]-(z) &quot;</span>
                     <span class="s">&quot;FOREACH(r IN rels| DELETE r) &quot;</span>
                     <span class="s">&quot;DELETE a, z&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;START a=node({a}) &quot;</span>
                     <span class="s">&quot;MATCH (a)-[rels*0..]-(z) &quot;</span>
                     <span class="s">&quot;FOREACH(r IN rels: DELETE r) &quot;</span>
                     <span class="s">&quot;DELETE a, z&quot;</span><span class="p">)</span>
        <span class="n">CypherQuery</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_db</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Node.isolate"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Node.isolate">[docs]</a>    <span class="k">def</span> <span class="nf">isolate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete all relationships connected to this node, both incoming and</span>
<span class="sd">        outgoing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CypherQuery</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_db</span><span class="p">,</span> <span class="s">&quot;START a=node({a}) &quot;</span>
                                   <span class="s">&quot;MATCH a-[r]-b &quot;</span>
                                   <span class="s">&quot;DELETE r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Node.match"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Node.match">[docs]</a>    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">other_node</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate through matching relationships attached to this node,</span>
<span class="sd">        regardless of direction.</span>

<span class="sd">        :param rel_type: type of relationships to match or :py:const:`None` if</span>
<span class="sd">            any</span>
<span class="sd">        :param other_node: concrete :py:class:`Node` to match for other end of</span>
<span class="sd">            relationship or :py:const:`None` if any</span>
<span class="sd">        :param limit: maximum number of relationships to match or</span>
<span class="sd">            :py:const:`None` if no limit</span>
<span class="sd">        :return: matching relationships</span>
<span class="sd">        :rtype: generator</span>

<span class="sd">        .. seealso::</span>
<span class="sd">           :py:func:`GraphDatabaseService.match &lt;py2neo.neo4j.GraphDatabaseService.match&gt;`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_root</span><span class="o">.</span><span class="n">graph_db</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_type</span><span class="p">,</span> <span class="n">other_node</span><span class="p">,</span>
                                                <span class="bp">True</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Node.match_incoming"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Node.match_incoming">[docs]</a>    <span class="k">def</span> <span class="nf">match_incoming</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">start_node</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate through matching relationships where this node is the end</span>
<span class="sd">        node.</span>

<span class="sd">        :param rel_type: type of relationships to match or :py:const:`None` if</span>
<span class="sd">            any</span>
<span class="sd">        :param start_node: concrete start :py:class:`Node` to match or</span>
<span class="sd">            :py:const:`None` if any</span>
<span class="sd">        :param limit: maximum number of relationships to match or</span>
<span class="sd">            :py:const:`None` if no limit</span>
<span class="sd">        :return: matching relationships</span>
<span class="sd">        :rtype: generator</span>

<span class="sd">        .. seealso::</span>
<span class="sd">           :py:func:`GraphDatabaseService.match &lt;py2neo.neo4j.GraphDatabaseService.match&gt;`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_root</span><span class="o">.</span><span class="n">graph_db</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">start_node</span><span class="p">,</span> <span class="n">rel_type</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span>
                                                <span class="bp">False</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Node.match_outgoing"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Node.match_outgoing">[docs]</a>    <span class="k">def</span> <span class="nf">match_outgoing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">end_node</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate through matching relationships where this node is the start</span>
<span class="sd">        node.</span>

<span class="sd">        :param rel_type: type of relationships to match or :py:const:`None` if</span>
<span class="sd">            any</span>
<span class="sd">        :param end_node: concrete end :py:class:`Node` to match or</span>
<span class="sd">            :py:const:`None` if any</span>
<span class="sd">        :param limit: maximum number of relationships to match or</span>
<span class="sd">            :py:const:`None` if no limit</span>
<span class="sd">        :return: matching relationships</span>
<span class="sd">        :rtype: generator</span>

<span class="sd">        .. seealso::</span>
<span class="sd">           :py:func:`GraphDatabaseService.match &lt;py2neo.neo4j.GraphDatabaseService.match&gt;`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_root</span><span class="o">.</span><span class="n">graph_db</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_type</span><span class="p">,</span> <span class="n">end_node</span><span class="p">,</span>
                                                <span class="bp">False</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Node.create_path"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Node.create_path">[docs]</a>    <span class="k">def</span> <span class="nf">create_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a new path, starting at this node and chaining together the</span>
<span class="sd">        alternating relationships and nodes provided::</span>

<span class="sd">            (self)-[rel_0]-&gt;(node_0)-[rel_1]-&gt;(node_1) ...</span>
<span class="sd">                   |-----|  |------| |-----|  |------|</span>
<span class="sd">             item:    0        1        2        3</span>

<span class="sd">        Each relationship may be specified as one of the following:</span>

<span class="sd">        - an existing Relationship instance</span>
<span class="sd">        - a string holding the relationship type, e.g. &quot;KNOWS&quot;</span>
<span class="sd">        - a (`str`, `dict`) tuple holding both the relationship type and</span>
<span class="sd">          its properties, e.g. (&quot;KNOWS&quot;, {&quot;since&quot;: 1999})</span>

<span class="sd">        Nodes can be any of the following:</span>

<span class="sd">        - an existing Node instance</span>
<span class="sd">        - an integer containing the ID of an existing node</span>
<span class="sd">        - a `dict` holding a set of properties for a new node</span>
<span class="sd">        - a 3-tuple holding an index name, key and value for identifying</span>
<span class="sd">          indexed nodes, e.g. (&quot;People&quot;, &quot;email&quot;, &quot;bob@example.com&quot;)</span>
<span class="sd">        - :py:const:`None`, representing an unspecified node that will be</span>
<span class="sd">          created as required</span>

<span class="sd">        :param items: alternating relationships and nodes</span>
<span class="sd">        :return: `Path` object representing the newly-created path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">items</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service_root</span><span class="o">.</span><span class="n">graph_db</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Node.get_or_create_path"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Node.get_or_create_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_create_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Identical to `create_path` except will reuse parts of the path</span>
<span class="sd">        which already exist.</span>

<span class="sd">        Some examples::</span>

<span class="sd">            # add dates to calendar, starting at calendar_root</span>
<span class="sd">            christmas_day = calendar_root.get_or_create_path(</span>
<span class="sd">                &quot;YEAR&quot;,  {&quot;number&quot;: 2000},</span>
<span class="sd">                &quot;MONTH&quot;, {&quot;number&quot;: 12},</span>
<span class="sd">                &quot;DAY&quot;,   {&quot;number&quot;: 25},</span>
<span class="sd">            )</span>
<span class="sd">            # `christmas_day` will now contain a `Path` object</span>
<span class="sd">            # containing the nodes and relationships used:</span>
<span class="sd">            # (CAL)-[:YEAR]-&gt;(2000)-[:MONTH]-&gt;(12)-[:DAY]-&gt;(25)</span>

<span class="sd">            # adding a second, overlapping path will reuse</span>
<span class="sd">            # nodes and relationships wherever possible</span>
<span class="sd">            christmas_eve = calendar_root.get_or_create_path(</span>
<span class="sd">                &quot;YEAR&quot;,  {&quot;number&quot;: 2000},</span>
<span class="sd">                &quot;MONTH&quot;, {&quot;number&quot;: 12},</span>
<span class="sd">                &quot;DAY&quot;,   {&quot;number&quot;: 24},</span>
<span class="sd">            )</span>
<span class="sd">            # `christmas_eve` will contain the same year and month nodes</span>
<span class="sd">            # as `christmas_day` but a different (new) day node:</span>
<span class="sd">            # (CAL)-[:YEAR]-&gt;(2000)-[:MONTH]-&gt;(12)-[:DAY]-&gt;(25)</span>
<span class="sd">            #                                  |</span>
<span class="sd">            #                                [:DAY]</span>
<span class="sd">            #                                  |</span>
<span class="sd">            #                                  v</span>
<span class="sd">            #                                 (24)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">items</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service_root</span><span class="o">.</span><span class="n">graph_db</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Node.update_properties"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Node.update_properties">[docs]</a>    <span class="k">def</span> <span class="nf">update_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update properties with the values supplied.</span>

<span class="sd">        :param properties: dictionary of properties to integrate with existing</span>
<span class="sd">            properties</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_abstract</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="n">compact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;START a=node({A})&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s">&quot;A&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">value_tag</span> <span class="o">=</span> <span class="s">&quot;V&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">query</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;SET a.`&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&quot;`={&quot;</span> <span class="o">+</span> <span class="n">value_tag</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="p">)</span>
                <span class="n">params</span><span class="p">[</span><span class="n">value_tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">query</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;RETURN a&quot;</span><span class="p">)</span>
            <span class="n">rel</span> <span class="o">=</span> <span class="n">CypherQuery</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_db</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query</span><span class="p">))</span><span class="o">.</span><span class="n">execute_one</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">]</span>
</div>
    <span class="k">def</span> <span class="nf">_label_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_abstract</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Abstract nodes cannot have labels&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subresource</span><span class="p">(</span><span class="s">&quot;labels&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Labels are not supported in this &quot;</span>
                                      <span class="s">&quot;version of Neo4j&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Node.get_labels"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Node.get_labels">[docs]</a>    <span class="k">def</span> <span class="nf">get_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch all labels associated with this node.</span>

<span class="sd">        :return: :py:class:`set` of text labels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">assembled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_label_resource</span><span class="p">()</span><span class="o">.</span><span class="n">_get</span><span class="p">()))</span>
</div>
<div class="viewcode-block" id="Node.add_labels"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Node.add_labels">[docs]</a>    <span class="k">def</span> <span class="nf">add_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add one or more labels to this node.</span>

<span class="sd">        For example::</span>

<span class="sd">            &gt;&gt;&gt; from py2neo import neo4j, node</span>
<span class="sd">            &gt;&gt;&gt; graph_db = neo4j.GraphDatabaseService()</span>
<span class="sd">            &gt;&gt;&gt; alice, = graph_db.create(node(name=&quot;Alice&quot;))</span>
<span class="sd">            &gt;&gt;&gt; alice.add_labels(&quot;female&quot;, &quot;human&quot;)</span>

<span class="sd">        :param labels: one or more text labels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">ustr</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">labels</span><span class="p">))]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_label_resource</span><span class="p">()</span><span class="o">.</span><span class="n">_post</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Node.remove_labels"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Node.remove_labels">[docs]</a>    <span class="k">def</span> <span class="nf">remove_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove one or more labels from this node.</span>

<span class="sd">        :param labels: one or more text labels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">ustr</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">labels</span><span class="p">))]</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">WriteBatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_db</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">remove_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Node.set_labels"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Node.set_labels">[docs]</a>    <span class="k">def</span> <span class="nf">set_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Replace all labels on this node.</span>

<span class="sd">        :param labels: one or more text labels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">ustr</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">labels</span><span class="p">))]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_label_resource</span><span class="p">()</span><span class="o">.</span><span class="n">_put</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="Relationship"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Relationship">[docs]</a><span class="k">class</span> <span class="nc">Relationship</span><span class="p">(</span><span class="n">_Entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A relationship within a graph, identified by a URI.</span>
<span class="sd">    </span>
<span class="sd">    :param uri: URI identifying this relationship</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">signature</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;self&quot;</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_hydrated</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;self&quot;</span><span class="p">])</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">ResourceMetadata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Relationship.abstract"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Relationship.abstract">[docs]</a>    <span class="k">def</span> <span class="nf">abstract</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">start_node</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">end_node</span><span class="p">,</span> <span class="o">**</span><span class="n">properties</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create and return a new abstract relationship.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_start_node</span> <span class="o">=</span> <span class="n">start_node</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">type_</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_end_node</span> <span class="o">=</span> <span class="n">end_node</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span>
</div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
        <span class="n">_Entity</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_node</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_end_node</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">_cast</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Relationship</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__uri__</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_Entity</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_node</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_start_node</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_type</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_end_node</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_end_node</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_properties</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">_cast</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Relationship</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__uri__</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_Entity</span><span class="o">.</span><span class="n">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_node</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_start_node</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_type</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_end_node</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_end_node</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_properties</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_abstract</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;{0}({1})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                <span class="nb">repr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__uri__</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;rel({1}, {2}, {3}, {4})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_node</span><span class="p">),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_node</span><span class="p">),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;rel({1}, {2}, {3})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_node</span><span class="p">),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_node</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">type_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SIMPLE_NAME</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">type_str</span><span class="p">):</span>
            <span class="n">type_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">type_str</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;{0}-[:{1} {2}]-&gt;{3}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_node</span><span class="p">),</span>
                <span class="n">type_str</span><span class="p">,</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_node</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;{0}-[:{1}]-&gt;{2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_node</span><span class="p">),</span>
                <span class="n">type_str</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_node</span><span class="p">),</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__uri__</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__uri__</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Relationship.end_node"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Relationship.end_node">[docs]</a>    <span class="k">def</span> <span class="nf">end_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the end node of this relationship.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__uri__</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_node</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_end_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">[</span><span class="s">&#39;end&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_node</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Relationship.start_node"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Relationship.start_node">[docs]</a>    <span class="k">def</span> <span class="nf">start_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the start node of this relationship.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__uri__</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_node</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">[</span><span class="s">&#39;start&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_node</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Relationship.type"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Relationship.type">[docs]</a>    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the type of this relationship as a string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__uri__</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span>
</div>
<div class="viewcode-block" id="Relationship.update_properties"><a class="viewcode-back" href="../../../graphs_nodes_relationships/#py2neo.neo4j.Relationship.update_properties">[docs]</a>    <span class="k">def</span> <span class="nf">update_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update the properties for this relationship with the values</span>
<span class="sd">        supplied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_abstract</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="n">compact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;START a=rel({A})&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s">&quot;A&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">value_tag</span> <span class="o">=</span> <span class="s">&quot;V&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">query</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;SET a.`&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&quot;`={&quot;</span> <span class="o">+</span> <span class="n">value_tag</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="p">)</span>
                <span class="n">params</span><span class="p">[</span><span class="n">value_tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">query</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;RETURN a&quot;</span><span class="p">)</span>
            <span class="n">rel</span> <span class="o">=</span> <span class="n">CypherQuery</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_db</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query</span><span class="p">))</span><span class="o">.</span><span class="n">execute_one</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">]</span>

</div></div>
<span class="k">class</span> <span class="nc">_UnboundRelationship</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; An abstract, partial relationship with no start or end nodes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">cast</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">arg</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Relationship</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="o">**</span><span class="n">arg</span><span class="o">.</span><span class="n">get_properties</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="o">**</span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">properties</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">type_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_type</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_properties</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_type</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_properties</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;({0}, {1})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">repr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">)),</span>
            <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;-[:{0}]-&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_node</span><span class="p">,</span> <span class="n">end_node</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Relationship</span><span class="o">.</span><span class="n">abstract</span><span class="p">(</span><span class="n">start_node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">,</span> <span class="n">end_node</span><span class="p">,</span>
                                     <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">)</span>


<div class="viewcode-block" id="Path"><a class="viewcode-back" href="../../../paths/#py2neo.neo4j.Path">[docs]</a><span class="k">class</span> <span class="nc">Path</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A representation of a sequence of nodes connected by relationships. for</span>
<span class="sd">    example::</span>

<span class="sd">        &gt;&gt;&gt; from py2neo import neo4j, node</span>
<span class="sd">        &gt;&gt;&gt; alice, bob, carol = node(name=&quot;Alice&quot;), node(name=&quot;Bob&quot;), node(name=&quot;Carol&quot;)</span>
<span class="sd">        &gt;&gt;&gt; abc = neo4j.Path(alice, &quot;KNOWS&quot;, bob, &quot;KNOWS&quot;, carol)</span>
<span class="sd">        &gt;&gt;&gt; abc.nodes</span>
<span class="sd">        [node(**{&#39;name&#39;: &#39;Alice&#39;}), node(**{&#39;name&#39;: &#39;Bob&#39;}), node(**{&#39;name&#39;: &#39;Carol&#39;})]</span>
<span class="sd">        &gt;&gt;&gt; dave, eve = node(name=&quot;Dave&quot;), node(name=&quot;Eve&quot;)</span>
<span class="sd">        &gt;&gt;&gt; de = neo4j.Path(dave, &quot;KNOWS&quot;, eve)</span>
<span class="sd">        &gt;&gt;&gt; de.nodes</span>
<span class="sd">        [node(**{&#39;name&#39;: &#39;Dave&#39;}), node(**{&#39;name&#39;: &#39;Eve&#39;})]</span>
<span class="sd">        &gt;&gt;&gt; abcde = neo4j.Path.join(abc, &quot;KNOWS&quot;, de)</span>
<span class="sd">        &gt;&gt;&gt; str(abcde)</span>
<span class="sd">        &#39;({&quot;name&quot;:&quot;Alice&quot;})-[:&quot;KNOWS&quot;]-&gt;({&quot;name&quot;:&quot;Bob&quot;})-[:&quot;KNOWS&quot;]-&gt;({&quot;name&quot;:&quot;Carol&quot;})-[:&quot;KNOWS&quot;]-&gt;({&quot;name&quot;:&quot;Dave&quot;})-[:&quot;KNOWS&quot;]-&gt;({&quot;name&quot;:&quot;Eve&quot;})&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">signature</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;length&quot;</span><span class="p">,</span> <span class="s">&quot;nodes&quot;</span><span class="p">,</span> <span class="s">&quot;relationships&quot;</span><span class="p">,</span> <span class="s">&quot;start&quot;</span><span class="p">,</span> <span class="s">&quot;end&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_hydrated</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;nodes&quot;</span><span class="p">])</span>
        <span class="n">rels</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">Relationship</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;relationships&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="o">*</span><span class="n">round_robin</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">rels</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">rels_and_nodes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_node</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_node</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">rels_and_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rels_and_nodes</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># If a trailing relationship is supplied, add a dummy end node</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_node</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_relationships</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_UnboundRelationship</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rels_and_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">round_robin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">,</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">_relationships</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">&quot;Path({0})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_relationships</span><span class="p">):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rel</span><span class="p">))</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_relationships</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_relationships</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_nodes</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_relationships</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_relationships</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_nodes</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_relationships</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_relationships</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_relationships</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">adjust</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span> <span class="o">+</span> <span class="n">size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Steps not supported in path slicing&quot;</span><span class="p">)</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">adjust</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">adjust</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="n">start</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
                <span class="n">path</span><span class="o">.</span><span class="n">_relationships</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_relationships</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">path</span><span class="o">.</span><span class="n">_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_relationships</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relationships</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span>
            <span class="n">_rel</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_relationships</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Path.order"><a class="viewcode-back" href="../../../paths/#py2neo.neo4j.Path.order">[docs]</a>    <span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The number of nodes within this path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Path.size"><a class="viewcode-back" href="../../../paths/#py2neo.neo4j.Path.size">[docs]</a>    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The number of relationships within this path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_relationships</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Path.nodes"><a class="viewcode-back" href="../../../paths/#py2neo.neo4j.Path.nodes">[docs]</a>    <span class="k">def</span> <span class="nf">nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a list of all the nodes which make up this path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Path.relationships"><a class="viewcode-back" href="../../../paths/#py2neo.neo4j.Path.relationships">[docs]</a>    <span class="k">def</span> <span class="nf">relationships</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a list of all the relationships which make up this path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">_rel</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_relationships</span><span class="p">)</span>
        <span class="p">]</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Path.join"><a class="viewcode-back" href="../../../paths/#py2neo.neo4j.Path.join">[docs]</a>    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">rel</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Join the two paths `left` and `right` with the relationship `rel`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">left</span><span class="p">[:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">right</span><span class="p">[:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
        <span class="n">left</span><span class="o">.</span><span class="n">_relationships</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_UnboundRelationship</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">rel</span><span class="p">))</span>
        <span class="n">left</span><span class="o">.</span><span class="n">_nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">right</span><span class="o">.</span><span class="n">_nodes</span><span class="p">)</span>
        <span class="n">left</span><span class="o">.</span><span class="n">_relationships</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">right</span><span class="o">.</span><span class="n">_relationships</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">left</span>
</div>
    <span class="k">def</span> <span class="nf">_create_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique</span><span class="p">):</span>
        <span class="n">nodes</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">append_node</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;(n{0})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;n{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">is_abstract</span><span class="p">:</span>
                <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;(n{0} {{p{0}}})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">params</span><span class="p">[</span><span class="s">&quot;p{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">compact</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">_properties</span><span class="p">)</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;n{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;(n{0})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;n{0}=node({{i{0}}})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">params</span><span class="p">[</span><span class="s">&quot;i{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">_id</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;n{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">append_rel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">rel</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rel</span><span class="o">.</span><span class="n">_properties</span><span class="p">:</span>
                <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;-[r{0}:`{1}` {{q{0}}}]-&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">rel</span><span class="o">.</span><span class="n">_type</span><span class="p">))</span>
                <span class="n">params</span><span class="p">[</span><span class="s">&quot;q{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">compact</span><span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">_properties</span><span class="p">)</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;r{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;-[r{0}:`{1}`]-&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">rel</span><span class="o">.</span><span class="n">_type</span><span class="p">))</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;r{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="n">append_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_relationships</span><span class="p">):</span>
            <span class="n">append_rel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">rel</span><span class="p">)</span>
            <span class="n">append_node</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">clauses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;START {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nodes</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">unique</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;CREATE UNIQUE p={0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;CREATE p={0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
        <span class="c">#clauses.append(&quot;RETURN {0}&quot;.format(&quot;,&quot;.join(values)))</span>
        <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;RETURN p&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">clauses</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span><span class="p">,</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_db</span><span class="p">,</span> <span class="n">unique</span><span class="p">):</span>
        <span class="n">query</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_query</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="n">unique</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">CypherQuery</span><span class="p">(</span><span class="n">graph_db</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CypherError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s">&quot;The Neo4j server at &lt;{0}&gt; does not support &quot;</span>
                <span class="s">&quot;Cypher CREATE UNIQUE clauses or the query contains &quot;</span>
                <span class="s">&quot;an unsupported property type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">graph_db</span><span class="o">.</span><span class="n">__uri__</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="Path.create"><a class="viewcode-back" href="../../../paths/#py2neo.neo4j.Path.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct a path within the specified `graph_db` from the nodes</span>
<span class="sd">        and relationships within this :py:class:`Path` instance. This makes</span>
<span class="sd">        use of Cypher&#39;s ``CREATE`` clause.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">(</span><span class="n">graph_db</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Path.get_or_create"><a class="viewcode-back" href="../../../paths/#py2neo.neo4j.Path.get_or_create">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct a unique path within the specified `graph_db` from the</span>
<span class="sd">        nodes and relationships within this :py:class:`Path` instance. This</span>
<span class="sd">        makes use of Cypher&#39;s ``CREATE UNIQUE`` clause.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">(</span><span class="n">graph_db</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="Index"><a class="viewcode-back" href="../../../indexes/#py2neo.neo4j.Index">[docs]</a><span class="k">class</span> <span class="nc">Index</span><span class="p">(</span><span class="n">Cacheable</span><span class="p">,</span> <span class="n">Resource</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Searchable database index which can contain either nodes or</span>
<span class="sd">    relationships.</span>

<span class="sd">    .. seealso:: :py:func:`GraphDatabaseService.get_or_create_index`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">=</span> <span class="n">content_type</span>
        <span class="n">key_value_pos</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;/{key}/{value}&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key_value_pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_searcher</span> <span class="o">=</span> <span class="n">ResourceTemplate</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
            <span class="n">Resource</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">URI</span><span class="p">(</span><span class="n">uri</span><span class="p">[:</span><span class="n">key_value_pos</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Resource</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_searcher</span> <span class="o">=</span> <span class="n">ResourceTemplate</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">string</span> <span class="o">+</span> <span class="s">&quot;/{key}/{value}&quot;</span><span class="p">)</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="n">URI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_db</span><span class="o">.</span><span class="n">neo4j_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_or_fail</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="s">&quot;?uniqueness=create_or_fail&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="s">&quot;?uniqueness=get_or_create&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_or_fail</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="s">&quot;?unique&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query_template</span> <span class="o">=</span> <span class="n">ResourceTemplate</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">string</span> <span class="o">+</span> <span class="s">&quot;{?query,order}&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__searcher_stem_cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;{0}({1}, {2})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
            <span class="nb">repr</span><span class="p">(</span><span class="n">URI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_searcher_stem_for_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__searcher_stem_cache</span><span class="p">:</span>
            <span class="n">stem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_searcher</span><span class="o">.</span><span class="n">uri_template</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&quot;{key}&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__searcher_stem_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">stem</span> <span class="o">+</span> <span class="n">percent_encode</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__searcher_stem_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

<div class="viewcode-block" id="Index.add"><a class="viewcode-back" href="../../../indexes/#py2neo.neo4j.Index.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add an entity to this index under the `key`:`value` pair supplied::</span>

<span class="sd">            # create a node and obtain a reference to the &quot;People&quot; node index</span>
<span class="sd">            alice, = graph_db.create({&quot;name&quot;: &quot;Alice Smith&quot;})</span>
<span class="sd">            people = graph_db.get_or_create_index(neo4j.Node, &quot;People&quot;)</span>

<span class="sd">            # add the node to the index</span>
<span class="sd">            people.add(&quot;family_name&quot;, &quot;Smith&quot;, alice)</span>

<span class="sd">        Note that while Neo4j indexes allow multiple entities to be added under</span>
<span class="sd">        a particular key:value, the same entity may only be represented once;</span>
<span class="sd">        this method is therefore idempotent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_post</span><span class="p">({</span>
            <span class="s">&quot;key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span>
            <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
            <span class="s">&quot;uri&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">URI</span><span class="p">(</span><span class="n">entity</span><span class="p">))</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">entity</span>
</div>
<div class="viewcode-block" id="Index.add_if_none"><a class="viewcode-back" href="../../../indexes/#py2neo.neo4j.Index.add_if_none">[docs]</a>    <span class="k">def</span> <span class="nf">add_if_none</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add an entity to this index under the `key`:`value` pair</span>
<span class="sd">        supplied if no entry already exists at that point::</span>

<span class="sd">            # obtain a reference to the &quot;Rooms&quot; node index and</span>
<span class="sd">            # add node `alice` to room 100 if empty</span>
<span class="sd">            rooms = graph_db.get_or_create_index(neo4j.Node, &quot;Rooms&quot;)</span>
<span class="sd">            rooms.add_if_none(&quot;room&quot;, 100, alice)</span>

<span class="sd">        If added, this method returns the entity, otherwise :py:const:`None`</span>
<span class="sd">        is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create</span><span class="o">.</span><span class="n">_post</span><span class="p">({</span>
            <span class="s">&quot;key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span>
            <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
            <span class="s">&quot;uri&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">URI</span><span class="p">(</span><span class="n">entity</span><span class="p">))</span>
        <span class="p">})</span>
        <span class="k">if</span> <span class="n">rs</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">CREATED</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">entity</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Index.content_type"><a class="viewcode-back" href="../../../indexes/#py2neo.neo4j.Index.content_type">[docs]</a>    <span class="k">def</span> <span class="nf">content_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the type of entity contained within this index. Will return</span>
<span class="sd">        either :py:class:`Node` or :py:class:`Relationship`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Index.name"><a class="viewcode-back" href="../../../indexes/#py2neo.neo4j.Index.name">[docs]</a>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the name of this index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
</div>
<div class="viewcode-block" id="Index.get"><a class="viewcode-back" href="../../../indexes/#py2neo.neo4j.Index.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch a list of all entities from the index which are associated</span>
<span class="sd">        with the `key`:`value` pair supplied::</span>

<span class="sd">            # obtain a reference to the &quot;People&quot; node index and</span>
<span class="sd">            # get all nodes where `family_name` equals &quot;Smith&quot;</span>
<span class="sd">            people = graph_db.get_or_create_index(neo4j.Node, &quot;People&quot;)</span>
<span class="sd">            smiths = people.get(&quot;family_name&quot;, &quot;Smith&quot;)</span>

<span class="sd">        ..</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">_hydrated</span><span class="p">(</span><span class="n">assembled</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_searcher</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">_get</span><span class="p">())</span>
        <span class="p">]</span>
</div>
<div class="viewcode-block" id="Index.create"><a class="viewcode-back" href="../../../indexes/#py2neo.neo4j.Index.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">abstract</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create and index a new node or relationship using the abstract</span>
<span class="sd">        provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">WriteBatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service_root</span><span class="o">.</span><span class="n">graph_db</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="ow">is</span> <span class="n">Node</span><span class="p">:</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">abstract</span><span class="p">)</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">add_indexed_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="ow">is</span> <span class="n">Relationship</span><span class="p">:</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">abstract</span><span class="p">)</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">add_indexed_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span><span class="p">)</span>
        <span class="n">entity</span><span class="p">,</span> <span class="n">index_entry</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">submit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">entity</span>
</div>
    <span class="k">def</span> <span class="nf">_create_unique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">abstract</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Internal method to support `get_or_create` and `create_if_none`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="ow">is</span> <span class="n">Node</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&quot;key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span>
                <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                <span class="s">&quot;properties&quot;</span><span class="p">:</span> <span class="n">abstract</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="ow">is</span> <span class="n">Relationship</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&quot;key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span>
                <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                <span class="s">&quot;start&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">abstract</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__uri__</span><span class="p">),</span>
                <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="n">abstract</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s">&quot;end&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">abstract</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">__uri__</span><span class="p">),</span>
                <span class="s">&quot;properties&quot;</span><span class="p">:</span> <span class="n">abstract</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">abstract</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create</span><span class="o">.</span><span class="n">_post</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>

<div class="viewcode-block" id="Index.get_or_create"><a class="viewcode-back" href="../../../indexes/#py2neo.neo4j.Index.get_or_create">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">abstract</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch a single entity from the index which is associated with the</span>
<span class="sd">        `key`:`value` pair supplied, creating a new entity with the supplied</span>
<span class="sd">        details if none exists::</span>

<span class="sd">            # obtain a reference to the &quot;Contacts&quot; node index and</span>
<span class="sd">            # ensure that Alice exists therein</span>
<span class="sd">            contacts = graph_db.get_or_create_index(neo4j.Node, &quot;Contacts&quot;)</span>
<span class="sd">            alice = contacts.get_or_create(&quot;name&quot;, &quot;SMITH, Alice&quot;, {</span>
<span class="sd">                &quot;given_name&quot;: &quot;Alice Jane&quot;, &quot;family_name&quot;: &quot;Smith&quot;,</span>
<span class="sd">                &quot;phone&quot;: &quot;01234 567 890&quot;, &quot;mobile&quot;: &quot;07890 123 456&quot;</span>
<span class="sd">            })</span>

<span class="sd">            # obtain a reference to the &quot;Friendships&quot; relationship index and</span>
<span class="sd">            # ensure that Alice and Bob&#39;s friendship is registered (`alice`</span>
<span class="sd">            # and `bob` refer to existing nodes)</span>
<span class="sd">            friendships = graph_db.get_or_create_index(neo4j.Relationship, &quot;Friendships&quot;)</span>
<span class="sd">            alice_and_bob = friendships.get_or_create(</span>
<span class="sd">                &quot;friends&quot;, &quot;Alice &amp; Bob&quot;, (alice, &quot;KNOWS&quot;, bob)</span>
<span class="sd">            )</span>

<span class="sd">        ..</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_hydrated</span><span class="p">(</span><span class="n">assembled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_unique</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">abstract</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="Index.create_if_none"><a class="viewcode-back" href="../../../indexes/#py2neo.neo4j.Index.create_if_none">[docs]</a>    <span class="k">def</span> <span class="nf">create_if_none</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">abstract</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a new entity with the specified details within the current</span>
<span class="sd">        index, under the `key`:`value` pair supplied, if no such entity already</span>
<span class="sd">        exists. If creation occurs, the new entity will be returned, otherwise</span>
<span class="sd">        :py:const:`None` will be returned::</span>

<span class="sd">            # obtain a reference to the &quot;Contacts&quot; node index and</span>
<span class="sd">            # create a node for Alice if one does not already exist</span>
<span class="sd">            contacts = graph_db.get_or_create_index(neo4j.Node, &quot;Contacts&quot;)</span>
<span class="sd">            alice = contacts.create_if_none(&quot;name&quot;, &quot;SMITH, Alice&quot;, {</span>
<span class="sd">                &quot;given_name&quot;: &quot;Alice Jane&quot;, &quot;family_name&quot;: &quot;Smith&quot;,</span>
<span class="sd">                &quot;phone&quot;: &quot;01234 567 890&quot;, &quot;mobile&quot;: &quot;07890 123 456&quot;</span>
<span class="sd">            })</span>

<span class="sd">        ..</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_unique</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">abstract</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rs</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">CREATED</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_hydrated</span><span class="p">(</span><span class="n">assembled</span><span class="p">(</span><span class="n">rs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Index.remove"><a class="viewcode-back" href="../../../indexes/#py2neo.neo4j.Index.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove any entries from the index which match the parameters</span>
<span class="sd">        supplied. The allowed parameter combinations are:</span>

<span class="sd">        `key`, `value`, `entity`</span>
<span class="sd">            remove a specific entity indexed under a given key-value pair</span>

<span class="sd">        `key`, `value`</span>
<span class="sd">            remove all entities indexed under a given key-value pair</span>

<span class="sd">        `key`, `entity`</span>
<span class="sd">            remove a specific entity indexed against a given key but with</span>
<span class="sd">            any value</span>

<span class="sd">        `entity`</span>
<span class="sd">            remove all occurrences of a specific entity regardless of</span>
<span class="sd">            key and value</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">entity</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">ResourceTemplate</span><span class="p">(</span><span class="n">URI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">string</span> <span class="o">+</span> <span class="s">&quot;/{key}/{value}/{entity}&quot;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="n">entity</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span><span class="o">.</span><span class="n">_delete</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">uris</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">URI</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">__metadata__</span><span class="p">[</span><span class="s">&quot;indexed&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">WriteBatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service_root</span><span class="o">.</span><span class="n">graph_db</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">uris</span><span class="p">:</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">append_delete</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">entity</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">ResourceTemplate</span><span class="p">(</span><span class="n">URI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">string</span> <span class="o">+</span> <span class="s">&quot;/{key}/{entity}&quot;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="n">entity</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span><span class="o">.</span><span class="n">_delete</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">entity</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">ResourceTemplate</span><span class="p">(</span><span class="n">URI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">string</span> <span class="o">+</span> <span class="s">&quot;/{entity}&quot;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">entity</span><span class="o">=</span><span class="n">entity</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span><span class="o">.</span><span class="n">_delete</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Illegal parameter combination for index removal&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Index.query"><a class="viewcode-back" href="../../../indexes/#py2neo.neo4j.Index.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Query the index according to the supplied query criteria, returning</span>
<span class="sd">        a list of matched entities::</span>

<span class="sd">            # obtain a reference to the &quot;People&quot; node index and</span>
<span class="sd">            # get all nodes where `family_name` equals &quot;Smith&quot;</span>
<span class="sd">            people = graph_db.get_or_create_index(neo4j.Node, &quot;People&quot;)</span>
<span class="sd">            s_people = people.query(&quot;family_name:S*&quot;)</span>

<span class="sd">        The query syntax used should be appropriate for the configuration of</span>
<span class="sd">        the index being queried. For indexes with default configuration, this</span>
<span class="sd">        should be Apache Lucene query syntax.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_template</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">_get</span><span class="p">()):</span>
            <span class="k">yield</span> <span class="n">_hydrated</span><span class="p">(</span><span class="n">assembled</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_query_with_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_template</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">_get</span><span class="p">()):</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">assembled</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">_hydrated</span><span class="p">(</span><span class="n">meta</span><span class="p">),</span> <span class="n">meta</span><span class="p">[</span><span class="s">&quot;score&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">query_by_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_with_score</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s">&quot;index&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">query_by_relevance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_with_score</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s">&quot;relevance&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">query_by_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_with_score</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s">&quot;score&quot;</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">_cast</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">Relationship</span><span class="p">),</span> <span class="n">abstract</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">_node</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Relationship</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">_rel</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">abstract</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">abstract</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">is_abstract</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">entity</span>


<span class="k">class</span> <span class="nc">BatchRequest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Individual batch request.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span> <span class="o">=</span> <span class="n">uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_body</span> <span class="o">=</span> <span class="n">body</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">id</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uri</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_body</span>


<span class="k">class</span> <span class="nc">BatchResponse</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Individual batch response.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__hydrate</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">hydration_cache</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;body&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">has_all</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">CypherResults</span><span class="o">.</span><span class="n">signature</span><span class="p">):</span>
                <span class="n">records</span> <span class="o">=</span> <span class="n">CypherResults</span><span class="o">.</span><span class="n">_hydrated</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">hydration_cache</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">records</span>
            <span class="k">elif</span> <span class="n">has_all</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;exception&quot;</span><span class="p">,</span> <span class="s">&quot;stacktrace&quot;</span><span class="p">)):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">ServerException</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">CustomBatchError</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">exception</span><span class="p">,</span> <span class="p">(</span><span class="n">BatchError</span><span class="p">,),</span> <span class="p">{})</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="c"># for Python 2.x</span>
                    <span class="n">CustomBatchError</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">exception</span><span class="p">),</span> <span class="p">(</span><span class="n">BatchError</span><span class="p">,),</span> <span class="p">{})</span>
                <span class="k">raise</span> <span class="n">CustomBatchError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_hydrated</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">hydration_cache</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_hydrated</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">hydration_cache</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">hydration_cache</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;from&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;body&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;status&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">URI</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;location&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="n">batch_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;&lt;&lt;&lt; {{{0}}} {1} {2} {3}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">))</span>
        <span class="c"># We need to hydrate on construction to catch any errors in the batch</span>
        <span class="c"># responses contained in the body</span>
        <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__hydrated</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__hydrated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hydrate</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">hydration_cache</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__uri__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hydrated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hydrated</span>


<span class="k">class</span> <span class="nc">BatchRequestList</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_db</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_db</span> <span class="o">=</span> <span class="n">graph_db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch</span> <span class="o">=</span> <span class="n">graph_db</span><span class="o">.</span><span class="n">_subresource</span><span class="p">(</span><span class="s">&quot;batch&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cypher</span> <span class="o">=</span> <span class="n">graph_db</span><span class="o">.</span><span class="n">_subresource</span><span class="p">(</span><span class="s">&quot;cypher&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cypher_uri</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_requests</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_requests</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_requests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span>

    <span class="k">def</span> <span class="nf">append_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BatchRequest</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">append_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BatchRequest</span><span class="p">(</span><span class="s">&quot;PUT&quot;</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">body</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">append_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BatchRequest</span><span class="p">(</span><span class="s">&quot;POST&quot;</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">body</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">append_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BatchRequest</span><span class="p">(</span><span class="s">&quot;DELETE&quot;</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">append_cypher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Append a Cypher query to this batch. Resources returned from Cypher</span>
<span class="sd">        queries cannot be referenced by other batch requests.</span>

<span class="sd">        :param query: Cypher query</span>
<span class="sd">        :type query: :py:class:`str`</span>
<span class="sd">        :param params: query parameters</span>
<span class="sd">        :type params: :py:class:`dict`</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        :rtype: :py:class:`_Batch.Request`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;query&quot;</span><span class="p">:</span> <span class="n">ustr</span><span class="p">(</span><span class="n">query</span><span class="p">),</span> <span class="s">&quot;params&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">params</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;query&quot;</span><span class="p">:</span> <span class="n">ustr</span><span class="p">(</span><span class="n">query</span><span class="p">)}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cypher_uri</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cypher_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cypher</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__cypher_uri</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                <span class="s">&quot;method&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="s">&quot;to&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">uri</span><span class="p">),</span>
                <span class="s">&quot;body&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">request</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_requests</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clear all requests from this batch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_requests</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Find the position of a request within this batch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">pendulate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_requests</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">req</span> <span class="o">==</span> <span class="n">request</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">i</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Request not found&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_uri_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="o">*</span><span class="n">segments</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a relative URI in string format for the entity specified</span>
<span class="sd">        plus extra path segments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="s">&quot;{{{0}}}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">BatchRequest</span><span class="p">):</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="s">&quot;{{{0}}}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">resource</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">service_root</span><span class="o">.</span><span class="n">graph_db</span><span class="o">.</span><span class="n">__uri__</span><span class="p">)</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">__uri__</span><span class="p">)[</span><span class="n">offset</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">segments</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">uri</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">):</span>
                <span class="n">uri</span> <span class="o">+=</span> <span class="s">&quot;/&quot;</span>
            <span class="n">uri</span> <span class="o">+=</span> <span class="s">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">percent_encode</span><span class="p">,</span> <span class="n">segments</span><span class="p">))</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;query&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">query</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">+=</span> <span class="s">&quot;?&quot;</span> <span class="o">+</span> <span class="n">query</span>
        <span class="k">return</span> <span class="n">uri</span>

    <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">request_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">request_text</span> <span class="o">=</span> <span class="s">&quot;request&quot;</span> <span class="k">if</span> <span class="n">request_count</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s">&quot;requests&quot;</span>
        <span class="n">batch_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Executing batch with {0} {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request_count</span><span class="p">,</span> <span class="n">request_text</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">request</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_requests</span><span class="p">):</span>
                <span class="n">batch_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;&gt;&gt;&gt; {{{0}}} {1} {2} {3}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch</span><span class="o">.</span><span class="n">_post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_body</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ClientError</span><span class="p">,</span> <span class="n">ServerError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="p">:</span>
                <span class="c"># A CustomBatchError is a dynamically created subclass of</span>
                <span class="c"># BatchError with the same name as the underlying server</span>
                <span class="c"># exception</span>
                <span class="n">CustomBatchError</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="p">),</span> <span class="p">(</span><span class="n">BatchError</span><span class="p">,),</span> <span class="p">{})</span>
                <span class="k">raise</span> <span class="n">CustomBatchError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">BatchError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Execute the batch on the server and discard the results. If the</span>
<span class="sd">        batch results are not required, this will generally be the fastest</span>
<span class="sd">        execution method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">stream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Execute the batch on the server and return iterable results. This</span>
<span class="sd">        method allows handling of results as they are received from the server.</span>

<span class="sd">        :return: iterable results</span>
<span class="sd">        :rtype: :py:class:`BatchResponseList`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">BatchResponseList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Execute the batch on the server and return a list of results. This</span>
<span class="sd">        method blocks until all results are received.</span>

<span class="sd">        :return: result records</span>
<span class="sd">        :rtype: :py:class:`list`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">()</span>
        <span class="n">hydration_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">BatchResponse</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">hydration_cache</span><span class="o">=</span><span class="n">hydration_cache</span><span class="p">)</span><span class="o">.</span><span class="n">hydrated</span>
                    <span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="n">responses</span><span class="o">.</span><span class="n">json</span><span class="p">]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">responses</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch an Index object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">Index</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">content_type</span> <span class="o">==</span> <span class="n">index</span><span class="o">.</span><span class="n">_content_type</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">index</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Index is not for {0}s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">content_type</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_db</span><span class="o">.</span><span class="n">get_or_create_index</span><span class="p">(</span><span class="n">content_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">BatchResponseList</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span> <span class="o">=</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hydration_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">BatchResponse</span><span class="p">(</span><span class="n">assembled</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
                                <span class="n">hydration_cache</span><span class="o">=</span><span class="n">hydration_cache</span><span class="p">)</span><span class="o">.</span><span class="n">hydrated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">closed</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<div class="viewcode-block" id="ReadBatch"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.ReadBatch">[docs]</a><span class="k">class</span> <span class="nc">ReadBatch</span><span class="p">(</span><span class="n">BatchRequestList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Generic batch execution facility for data read requests,</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_db</span><span class="p">):</span>
        <span class="n">BatchRequestList</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_db</span><span class="p">)</span>

<div class="viewcode-block" id="ReadBatch.get_indexed_nodes"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.ReadBatch.get_indexed_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">get_indexed_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch all nodes indexed under a given key-value pair.</span>

<span class="sd">        :param index: index name or instance</span>
<span class="sd">        :type index: :py:class:`str` or :py:class:`Index`</span>
<span class="sd">        :param key: key under which nodes are indexed</span>
<span class="sd">        :type key: :py:class:`str`</span>
<span class="sd">        :param value: value under which nodes are indexed</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">_searcher_stem_for_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="n">percent_encode</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_get</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="WriteBatch"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.WriteBatch">[docs]</a><span class="k">class</span> <span class="nc">WriteBatch</span><span class="p">(</span><span class="n">BatchRequestList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Generic batch execution facility for data write requests. Most methods</span>
<span class="sd">    return a :py:class:`BatchRequest &lt;py2neo.neo4j.BatchRequest&gt;` object that</span>
<span class="sd">    can be used as a reference in other methods. See the</span>
<span class="sd">    :py:meth:`create &lt;py2neo.neo4j.WriteBatch.create&gt;` method for an example</span>
<span class="sd">    of this.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_db</span><span class="p">):</span>
        <span class="n">BatchRequestList</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__new_uniqueness_modes</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">supports_index_uniqueness_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_db</span><span class="o">.</span><span class="n">supports_index_uniqueness_modes</span>

    <span class="k">def</span> <span class="nf">_assert_can_create_or_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">supports_index_uniqueness_modes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Uniqueness mode `create_or_fail` &quot;</span>
                                      <span class="s">&quot;requires version 1.9 or above&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="WriteBatch.create"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.WriteBatch.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abstract</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a node or relationship based on the abstract entity</span>
<span class="sd">        provided. For example::</span>

<span class="sd">            batch = WriteBatch(graph_db)</span>
<span class="sd">            a = batch.create(node(name=&quot;Alice&quot;))</span>
<span class="sd">            b = batch.create(node(name=&quot;Bob&quot;))</span>
<span class="sd">            batch.create(rel(a, &quot;KNOWS&quot;, b))</span>
<span class="sd">            results = batch.submit()</span>

<span class="sd">        :param abstract: node or relationship</span>
<span class="sd">        :type abstract: abstract</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">_cast</span><span class="p">(</span><span class="n">abstract</span><span class="p">,</span> <span class="n">abstract</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph_db</span><span class="o">.</span><span class="n">_subresource</span><span class="p">(</span><span class="s">&quot;node&quot;</span><span class="p">))</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">compact</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_properties</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">Relationship</span><span class="p">):</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">start_node</span><span class="p">,</span> <span class="s">&quot;relationships&quot;</span><span class="p">)</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="n">entity</span><span class="o">.</span><span class="n">_type</span><span class="p">,</span>
                <span class="s">&quot;to&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">end_node</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_properties</span><span class="p">:</span>
                <span class="n">body</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compact</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_properties</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_post</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WriteBatch.create_path"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.WriteBatch.create_path">[docs]</a>    <span class="k">def</span> <span class="nf">create_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">rels_and_nodes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct a path across a specified set of nodes and relationships.</span>
<span class="sd">        Nodes may be existing concrete node instances, abstract nodes or</span>
<span class="sd">        :py:const:`None` but references to other requests are not supported.</span>

<span class="sd">        :param node: start node</span>
<span class="sd">        :type node: concrete, abstract or :py:const:`None`</span>
<span class="sd">        :param rels_and_nodes: alternating relationships and nodes</span>
<span class="sd">        :type rels_and_nodes: concrete, abstract or :py:const:`None`</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">rels_and_nodes</span><span class="p">)</span><span class="o">.</span><span class="n">_create_query</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append_cypher</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WriteBatch.get_or_create_path"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.WriteBatch.get_or_create_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_create_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">rels_and_nodes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct a unique path across a specified set of nodes and</span>
<span class="sd">        relationships, adding only parts that are missing. Nodes may be</span>
<span class="sd">        existing concrete node instances, abstract nodes or :py:const:`None`</span>
<span class="sd">        but references to other requests are not supported.</span>

<span class="sd">        :param node: start node</span>
<span class="sd">        :type node: concrete, abstract or :py:const:`None`</span>
<span class="sd">        :param rels_and_nodes: alternating relationships and nodes</span>
<span class="sd">        :type rels_and_nodes: concrete, abstract or :py:const:`None`</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">rels_and_nodes</span><span class="p">)</span><span class="o">.</span><span class="n">_create_query</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append_cypher</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</div>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="s">&quot;WriteBatch.get_or_create is deprecated, please use &quot;</span>
                <span class="s">&quot;get_or_create_path instead&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="WriteBatch.get_or_create"><a class="viewcode-back" href="../../../deprecated_features/#py2neo.neo4j.WriteBatch.get_or_create">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_abstract</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Use the abstract supplied to create a new relationship if one does</span>
<span class="sd">        not already exist.</span>

<span class="sd">        :param rel_abstract: relationship abstract to be fetched or created</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rel</span> <span class="o">=</span> <span class="n">_cast</span><span class="p">(</span><span class="n">rel_abstract</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">Relationship</span><span class="p">,</span> <span class="n">abstract</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">_start_node</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span> <span class="ow">or</span> <span class="n">rel</span><span class="o">.</span><span class="n">_start_node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Relationship start node must be a &quot;</span>
                            <span class="s">&quot;Node instance or None&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">_end_node</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span> <span class="ow">or</span> <span class="n">rel</span><span class="o">.</span><span class="n">_end_node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Relationship end node must be a &quot;</span>
                            <span class="s">&quot;Node instance or None&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rel</span><span class="o">.</span><span class="n">_start_node</span> <span class="ow">and</span> <span class="n">rel</span><span class="o">.</span><span class="n">_end_node</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s">&quot;START a=node({A}), b=node({B}) &quot;</span>
                <span class="s">&quot;CREATE UNIQUE (a)-[ab:`&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">_type</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;` {P}]-&gt;(b) &quot;</span>
                <span class="s">&quot;RETURN ab&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">rel</span><span class="o">.</span><span class="n">_start_node</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s">&quot;START a=node({A}) &quot;</span>
                <span class="s">&quot;CREATE UNIQUE (a)-[ab:`&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">_type</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;` {P}]-&gt;() &quot;</span>
                <span class="s">&quot;RETURN ab&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">rel</span><span class="o">.</span><span class="n">_end_node</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s">&quot;START b=node({B}) &quot;</span>
                <span class="s">&quot;CREATE UNIQUE ()-[ab:`&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">_type</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;` {P}]-&gt;(b) &quot;</span>
                <span class="s">&quot;RETURN ab&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Either start node or end node must be &quot;</span>
                             <span class="s">&quot;specified for a unique relationship&quot;</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;P&quot;</span><span class="p">:</span> <span class="n">compact</span><span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">_properties</span> <span class="ow">or</span> <span class="p">{})}</span>
        <span class="k">if</span> <span class="n">rel</span><span class="o">.</span><span class="n">_start_node</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s">&quot;A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">_start_node</span><span class="o">.</span><span class="n">_id</span>
        <span class="k">if</span> <span class="n">rel</span><span class="o">.</span><span class="n">_end_node</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s">&quot;B&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">_end_node</span><span class="o">.</span><span class="n">_id</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_cypher</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WriteBatch.delete"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.WriteBatch.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete a node or relationship from the graph.</span>

<span class="sd">        :param entity: node or relationship to delete</span>
<span class="sd">        :type entity: concrete or reference</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="n">entity</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="WriteBatch.set_property"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.WriteBatch.set_property">[docs]</a>    <span class="k">def</span> <span class="nf">set_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set a single property on a node or relationship.</span>

<span class="sd">        :param entity: node or relationship on which to set property</span>
<span class="sd">        :type entity: concrete or reference</span>
<span class="sd">        :param key: property key</span>
<span class="sd">        :type key: :py:class:`str`</span>
<span class="sd">        :param value: property value</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_property</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s">&quot;properties&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_put</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WriteBatch.set_properties"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.WriteBatch.set_properties">[docs]</a>    <span class="k">def</span> <span class="nf">set_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Replace all properties on a node or relationship.</span>

<span class="sd">        :param entity: node or relationship on which to set properties</span>
<span class="sd">        :type entity: concrete or reference</span>
<span class="sd">        :param properties: properties</span>
<span class="sd">        :type properties: :py:class:`dict`</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s">&quot;properties&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_put</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">compact</span><span class="p">(</span><span class="n">properties</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="WriteBatch.delete_property"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.WriteBatch.delete_property">[docs]</a>    <span class="k">def</span> <span class="nf">delete_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete a single property from a node or relationship.</span>

<span class="sd">        :param entity: node or relationship from which to delete property</span>
<span class="sd">        :type entity: concrete or reference</span>
<span class="sd">        :param key: property key</span>
<span class="sd">        :type key: :py:class:`str`</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s">&quot;properties&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_delete</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WriteBatch.delete_properties"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.WriteBatch.delete_properties">[docs]</a>    <span class="k">def</span> <span class="nf">delete_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete all properties from a node or relationship.</span>

<span class="sd">        :param entity: node or relationship from which to delete properties</span>
<span class="sd">        :type entity: concrete or reference</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s">&quot;properties&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_delete</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WriteBatch.add_labels"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.WriteBatch.add_labels">[docs]</a>    <span class="k">def</span> <span class="nf">add_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add labels to a node.</span>

<span class="sd">        :param node: node to which to add labels</span>
<span class="sd">        :type entity: concrete or reference</span>
<span class="sd">        :param labels: text labels</span>
<span class="sd">        :type labels: :py:class:`str`</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;labels&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_post</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="WriteBatch.remove_label"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.WriteBatch.remove_label">[docs]</a>    <span class="k">def</span> <span class="nf">remove_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove a label from a node.</span>

<span class="sd">        :param node: node from which to remove labels (can be a reference to</span>
<span class="sd">            another request within the same batch)</span>
<span class="sd">        :param label: text label</span>
<span class="sd">        :type label: :py:class:`str`</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;labels&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_delete</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WriteBatch.set_labels"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.WriteBatch.set_labels">[docs]</a>    <span class="k">def</span> <span class="nf">set_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Replace all labels on a node.</span>

<span class="sd">        :param node: node on which to replace labels (can be a reference to</span>
<span class="sd">            another request within the same batch)</span>
<span class="sd">        :param labels: text labels</span>
<span class="sd">        :type labels: :py:class:`str`</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;labels&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_put</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

    <span class="c">### ADD TO INDEX ###</span>
</div>
    <span class="k">def</span> <span class="nf">_add_to_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">index</span><span class="p">),</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_post</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="p">{</span>
            <span class="s">&quot;key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span>
            <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
            <span class="s">&quot;uri&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="n">entity</span><span class="p">),</span>
        <span class="p">})</span>

<div class="viewcode-block" id="WriteBatch.add_to_index"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.WriteBatch.add_to_index">[docs]</a>    <span class="k">def</span> <span class="nf">add_to_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add an existing node or relationship to an index.</span>

<span class="sd">        :param cls: the type of indexed entity</span>
<span class="sd">        :type cls: :py:class:`Node &lt;py2neo.neo4j.Node&gt;` or</span>
<span class="sd">                   :py:class:`Relationship &lt;py2neo.neo4j.Relationship&gt;`</span>
<span class="sd">        :param index: index or index name</span>
<span class="sd">        :type index: :py:class:`Index &lt;py2neo.neo4j.Index&gt;` or :py:class:`str`</span>
<span class="sd">        :param key: index entry key</span>
<span class="sd">        :type key: :py:class:`str`</span>
<span class="sd">        :param value: index entry value</span>
<span class="sd">        :param entity: node or relationship to add to the index</span>
<span class="sd">        :type entity: concrete or reference</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_index</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WriteBatch.add_to_index_or_fail"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.WriteBatch.add_to_index_or_fail">[docs]</a>    <span class="k">def</span> <span class="nf">add_to_index_or_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add an existing node or relationship uniquely to an index, failing</span>
<span class="sd">        the entire batch if such an entry already exists.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            Uniqueness modes for legacy indexes have been broken in recent</span>
<span class="sd">            server versions and therefore this method may not work as expected.</span>

<span class="sd">        :param cls: the type of indexed entity</span>
<span class="sd">        :type cls: :py:class:`Node &lt;py2neo.neo4j.Node&gt;` or</span>
<span class="sd">                   :py:class:`Relationship &lt;py2neo.neo4j.Relationship&gt;`</span>
<span class="sd">        :param index: index or index name</span>
<span class="sd">        :type index: :py:class:`Index &lt;py2neo.neo4j.Index&gt;` or :py:class:`str`</span>
<span class="sd">        :param key: index entry key</span>
<span class="sd">        :type key: :py:class:`str`</span>
<span class="sd">        :param value: index entry value</span>
<span class="sd">        :param entity: node or relationship to add to the index</span>
<span class="sd">        :type entity: concrete or reference</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_can_create_or_fail</span><span class="p">()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;uniqueness=create_or_fail&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_index</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WriteBatch.get_or_add_to_index"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.WriteBatch.get_or_add_to_index">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_add_to_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch a uniquely indexed node or relationship if one exists,</span>
<span class="sd">        otherwise add an existing entity to the index.</span>

<span class="sd">        :param cls: the type of indexed entity</span>
<span class="sd">        :type cls: :py:class:`Node &lt;py2neo.neo4j.Node&gt;` or</span>
<span class="sd">                   :py:class:`Relationship &lt;py2neo.neo4j.Relationship&gt;`</span>
<span class="sd">        :param index: index or index name</span>
<span class="sd">        :type index: :py:class:`Index &lt;py2neo.neo4j.Index&gt;` or :py:class:`str`</span>
<span class="sd">        :param key: index entry key</span>
<span class="sd">        :type key: :py:class:`str`</span>
<span class="sd">        :param value: index entry value</span>
<span class="sd">        :param entity: node or relationship to add to the index</span>
<span class="sd">        :type entity: concrete or reference</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">supports_index_uniqueness_modes</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;uniqueness=get_or_create&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;unique&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_index</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

    <span class="c">### CREATE IN INDEX ###</span>
</div>
    <span class="k">def</span> <span class="nf">_create_in_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">abstract</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">index</span><span class="p">),</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="n">_cast</span><span class="p">(</span><span class="n">abstract</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">cls</span><span class="p">,</span> <span class="n">abstract</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cls</span> <span class="ow">is</span> <span class="n">Node</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_post</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="p">{</span>
                <span class="s">&quot;key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span>
                <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                <span class="s">&quot;properties&quot;</span><span class="p">:</span> <span class="n">compact</span><span class="p">(</span><span class="n">abstract</span><span class="o">.</span><span class="n">_properties</span> <span class="ow">or</span> <span class="p">{}),</span>
            <span class="p">})</span>
        <span class="k">elif</span> <span class="n">cls</span> <span class="ow">is</span> <span class="n">Relationship</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_post</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="p">{</span>
                <span class="s">&quot;key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span>
                <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                <span class="s">&quot;start&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="n">abstract</span><span class="o">.</span><span class="n">_start_node</span><span class="p">),</span>
                <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">abstract</span><span class="o">.</span><span class="n">_type</span><span class="p">),</span>
                <span class="s">&quot;end&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="n">abstract</span><span class="o">.</span><span class="n">_end_node</span><span class="p">),</span>
                <span class="s">&quot;properties&quot;</span><span class="p">:</span> <span class="n">abstract</span><span class="o">.</span><span class="n">_properties</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>

    <span class="c"># Removed create_in_index as parameter combination not supported by server</span>

<div class="viewcode-block" id="WriteBatch.create_in_index_or_fail"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.WriteBatch.create_in_index_or_fail">[docs]</a>    <span class="k">def</span> <span class="nf">create_in_index_or_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">abstract</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a new node or relationship and add it uniquely to an index,</span>
<span class="sd">        failing the entire batch if such an entry already exists.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            Uniqueness modes for legacy indexes have been broken in recent</span>
<span class="sd">            server versions and therefore this method may not work as expected.</span>

<span class="sd">        :param cls: the type of indexed entity</span>
<span class="sd">        :type cls: :py:class:`Node &lt;py2neo.neo4j.Node&gt;` or</span>
<span class="sd">                   :py:class:`Relationship &lt;py2neo.neo4j.Relationship&gt;`</span>
<span class="sd">        :param index: index or index name</span>
<span class="sd">        :type index: :py:class:`Index &lt;py2neo.neo4j.Index&gt;` or :py:class:`str`</span>
<span class="sd">        :param key: index entry key</span>
<span class="sd">        :type key: :py:class:`str`</span>
<span class="sd">        :param value: index entry value</span>
<span class="sd">        :param abstract: abstract node or relationship to create</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_can_create_or_fail</span><span class="p">()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;uniqueness=create_or_fail&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_in_index</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">abstract</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WriteBatch.get_or_create_in_index"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.WriteBatch.get_or_create_in_index">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_create_in_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">abstract</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fetch a uniquely indexed node or relationship if one exists,</span>
<span class="sd">        otherwise create a new entity and add that to the index.</span>

<span class="sd">        :param cls: the type of indexed entity</span>
<span class="sd">        :type cls: :py:class:`Node &lt;py2neo.neo4j.Node&gt;` or</span>
<span class="sd">                   :py:class:`Relationship &lt;py2neo.neo4j.Relationship&gt;`</span>
<span class="sd">        :param index: index or index name</span>
<span class="sd">        :type index: :py:class:`Index &lt;py2neo.neo4j.Index&gt;` or :py:class:`str`</span>
<span class="sd">        :param key: index entry key</span>
<span class="sd">        :type key: :py:class:`str`</span>
<span class="sd">        :param value: index entry value</span>
<span class="sd">        :param abstract: abstract node or relationship to create</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">supports_index_uniqueness_modes</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;uniqueness=get_or_create&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;unique&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_in_index</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">abstract</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

    <span class="c">### REMOVE FROM INDEX ###</span>
</div>
<div class="viewcode-block" id="WriteBatch.remove_from_index"><a class="viewcode-back" href="../../../batches/#py2neo.neo4j.WriteBatch.remove_from_index">[docs]</a>    <span class="k">def</span> <span class="nf">remove_from_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove any nodes or relationships from an index that match a</span>
<span class="sd">        particular set of criteria. Allowed parameter combinations are:</span>

<span class="sd">        `key`, `value`, `entity`</span>
<span class="sd">            remove a specific node or relationship indexed under a given</span>
<span class="sd">            key-value pair</span>

<span class="sd">        `key`, `entity`</span>
<span class="sd">            remove a specific node or relationship indexed against a given key</span>
<span class="sd">            and with any value</span>

<span class="sd">        `entity`</span>
<span class="sd">            remove all occurrences of a specific node or relationship</span>
<span class="sd">            regardless of key or value</span>

<span class="sd">        :param cls: the type of indexed entity</span>
<span class="sd">        :type cls: :py:class:`Node &lt;py2neo.neo4j.Node&gt;` or</span>
<span class="sd">                   :py:class:`Relationship &lt;py2neo.neo4j.Relationship&gt;`</span>
<span class="sd">        :param index: index or index name</span>
<span class="sd">        :type index: :py:class:`Index &lt;py2neo.neo4j.Index&gt;` or :py:class:`str`</span>
<span class="sd">        :param key: index entry key</span>
<span class="sd">        :type key: :py:class:`str`</span>
<span class="sd">        :param value: index entry value</span>
<span class="sd">        :param entity: node or relationship to remove from the index</span>
<span class="sd">        :type entity: concrete or reference</span>
<span class="sd">        :return: batch request object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">entity</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">entity</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">entity</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri_for</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Illegal parameter combination for index removal&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_delete</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>

    <span class="c">### START OF DEPRECATED METHODS ###</span>
</div>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="s">&quot;WriteBatch.add_indexed_node is deprecated, &quot;</span>
                <span class="s">&quot;use add_to_index instead&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_indexed_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_to_index</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="s">&quot;WriteBatch.add_indexed_relationship is deprecated, &quot;</span>
                <span class="s">&quot;use add_to_index instead&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_indexed_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">relationship</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_to_index</span><span class="p">(</span><span class="n">Relationship</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">relationship</span><span class="p">)</span>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="s">&quot;WriteBatch.add_indexed_node_or_fail is deprecated, &quot;</span>
                <span class="s">&quot;use add_to_index_or_fail instead&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_indexed_node_or_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_to_index_or_fail</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="s">&quot;WriteBatch.add_indexed_relationship_or_fail is deprecated, &quot;</span>
                <span class="s">&quot;use add_to_index_or_fail instead&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_indexed_relationship_or_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">relationship</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_to_index_or_fail</span><span class="p">(</span><span class="n">Relationship</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
                                         <span class="n">relationship</span><span class="p">)</span>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="s">&quot;WriteBatch.create_indexed_node_or_fail is deprecated, &quot;</span>
                <span class="s">&quot;use create_in_index_or_fail instead&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">create_indexed_node_or_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_can_create_or_fail</span><span class="p">()</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="n">properties</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_in_index_or_fail</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">abstract</span><span class="p">)</span>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="s">&quot;WriteBatch.create_indexed_relationship_or_fail is deprecated, &quot;</span>
                <span class="s">&quot;use create_in_index_or_fail instead&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">create_indexed_relationship_or_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
                                            <span class="n">start_node</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">end_node</span><span class="p">,</span>
                                            <span class="n">properties</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_can_create_or_fail</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">abstract</span> <span class="o">=</span> <span class="n">_rel</span><span class="p">(</span><span class="n">start_node</span><span class="p">,</span> <span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="n">properties</span><span class="p">),</span> <span class="n">end_node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">abstract</span> <span class="o">=</span> <span class="n">_rel</span><span class="p">(</span><span class="n">start_node</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">end_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_in_index_or_fail</span><span class="p">(</span><span class="n">Relationship</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
                                            <span class="n">abstract</span><span class="p">)</span>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="s">&quot;WriteBatch.get_or_add_indexed_node is deprecated, &quot;</span>
                <span class="s">&quot;use get_or_add_to_index instead&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="WriteBatch.get_or_add_indexed_node"><a class="viewcode-back" href="../../../deprecated_features/#py2neo.neo4j.WriteBatch.get_or_add_indexed_node">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_add_indexed_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_or_add_to_index</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
</div>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="s">&quot;WriteBatch.get_or_add_indexed_relationship is deprecated, &quot;</span>
                <span class="s">&quot;use get_or_add_to_index instead&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="WriteBatch.get_or_add_indexed_relationship"><a class="viewcode-back" href="../../../deprecated_features/#py2neo.neo4j.WriteBatch.get_or_add_indexed_relationship">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_add_indexed_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">relationship</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_or_add_to_index</span><span class="p">(</span><span class="n">Relationship</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">relationship</span><span class="p">)</span>
</div>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="s">&quot;WriteBatch.get_or_create_indexed_node is deprecated, &quot;</span>
                <span class="s">&quot;use get_or_create_in_index instead&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_or_create_indexed_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="n">properties</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_or_create_in_index</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">abstract</span><span class="p">)</span>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="s">&quot;WriteBatch.get_or_create_indexed_relationship is deprecated, &quot;</span>
                <span class="s">&quot;use get_or_create_indexed instead&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_or_create_indexed_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">start_node</span><span class="p">,</span>
                                           <span class="n">type_</span><span class="p">,</span> <span class="n">end_node</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">abstract</span> <span class="o">=</span> <span class="n">_rel</span><span class="p">(</span><span class="n">start_node</span><span class="p">,</span> <span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="n">properties</span><span class="p">),</span> <span class="n">end_node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">abstract</span> <span class="o">=</span> <span class="n">_rel</span><span class="p">(</span><span class="n">start_node</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">end_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_or_create_in_index</span><span class="p">(</span><span class="n">Relationship</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
                                           <span class="n">abstract</span><span class="p">)</span>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="s">&quot;WriteBatch.remove_indexed_node is deprecated, &quot;</span>
                <span class="s">&quot;use remove_indexed instead&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="WriteBatch.remove_indexed_node"><a class="viewcode-back" href="../../../deprecated_features/#py2neo.neo4j.WriteBatch.remove_indexed_node">[docs]</a>    <span class="k">def</span> <span class="nf">remove_indexed_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_from_index</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
</div>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="s">&quot;WriteBatch.remove_indexed_relationship is deprecated, &quot;</span>
                <span class="s">&quot;use remove_indexed instead&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="WriteBatch.remove_indexed_relationship"><a class="viewcode-back" href="../../../deprecated_features/#py2neo.neo4j.WriteBatch.remove_indexed_relationship">[docs]</a>    <span class="k">def</span> <span class="nf">remove_indexed_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                    <span class="n">relationship</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_from_index</span><span class="p">(</span><span class="n">Relationship</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
                                      <span class="n">relationship</span><span class="p">)</span>

    <span class="c">### END OF DEPRECATED METHODS ###</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
    </main>
    <footer>
        <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Licence" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br>
This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
    </footer>

      <div class="clearer"></div>
    </div>

    <div class="footer">
    </div>
  </body>
</html>